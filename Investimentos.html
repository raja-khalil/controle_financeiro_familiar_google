<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Investimentos - Controle Financeiro Familiar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    body { 
      padding-top: 20px; 
      background-color: #f0f2f5; /* Fundo suave */
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
    }
    .container { 
      max-width: 1000px; 
      background-color: #ffffff; 
      padding: 30px; 
      border-radius: 12px; /* Cantos arredondados */
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); /* Sombra suave */
      margin-bottom: 50px; 
    }
    h1, h2, h3 { 
      color: #343a40; 
      margin-bottom: 25px; /* Espaçamento padrão */
      font-weight: 600;
    }
    .btn-back {
      margin-bottom: 20px;
      background-color: #6c757d; /* Cinza do Bootstrap */
      border-color: #6c757d;
      transition: all 0.3s ease;
    }
    .btn-back:hover {
      background-color: #5a6268;
      border-color: #545b62;
      transform: translateY(-1px);
    }
    .form-label {
      font-weight: 500;
      color: #495057;
    }
    .form-control, .form-select {
      border-radius: 8px;
      border: 1px solid #ced4da;
      padding: 0.75rem 1rem;
    }
    .form-control:focus, .form-select:focus {
      border-color: #80bdff;
      box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
    }
    .btn-primary, .btn-secondary, .btn-info, .btn-success, .btn-danger {
      border-radius: 8px;
      padding: 0.75rem 1.25rem;
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      background-color: #0056b3;
      border-color: #0056b3;
      transform: translateY(-1px);
    }
    .btn-info {
        background-color: #17a2b8;
        border-color: #17a2b8;
        color: #fff;
    }
    .btn-info:hover {
        background-color: #117a8b;
        border-color: #10707f;
        transform: translateY(-1px);
    }
    .btn-success {
        background-color: #28a745;
        border-color: #28a745;
    }
    .btn-success:hover {
        background-color: #1e7e34;
        border-color: #1c7430;
        transform: translateY(-1px);
    }
    .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
    }
    .btn-danger:hover {
        background-color: #bd2130;
        border-color: #b21f2d;
        transform: translateY(-1px);
    }
    .table thead th {
      background-color: #e9ecef;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
      padding: 1rem;
    }
    .table tbody tr:hover {
      background-color: #f2f2f2;
    }
    .table td {
      vertical-align: middle;
      padding: 0.75rem;
    }
    .alert-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; border-radius: 8px; }
    .alert-danger { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; border-radius: 8px; }
    .status-positive { color: #28a745; font-weight: bold; } /* Bootstrap green */
    .status-negative { color: #dc3545; font-weight: bold; } /* Bootstrap red */

    /* Estilo para modais */
    .modal-content {
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    .modal-header {
      border-bottom: 1px solid #dee2e6;
      background-color: #f8f9fa;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    .modal-title {
      color: #343a40;
    }
    .modal-footer {
      border-top: 1px solid #dee2e6;
    }

    /* Media queries para responsividade */
    @media (max-width: 768px) {
      .container {
        padding: 20px;
        border-radius: 8px;
      }
      h1, h2, h3 {
        font-size: 1.5em;
        margin-bottom: 20px;
      }
      .form-control, .form-select {
        padding: 0.6rem 0.8rem;
        font-size: 0.9rem;
      }
      .btn-primary, .btn-secondary, .btn-info, .btn-success, .btn-danger {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
      }
      .table th, .table td {
        padding: 0.6rem;
        font-size: 0.85rem;
      }
      .table-responsive .btn { /* Ajuste para botões pequenos na tabela em mobile */
        padding: 0.4rem 0.6rem;
        font-size: 0.75rem;
        margin-bottom: 5px; /* Espaçamento entre botões empilhados */
      }
      .progress { height: 20px; }
      .progress-bar { line-height: 20px; font-size: 0.8em;}
      .badge { font-size: 0.75em; padding: 0.4em 0.6em; }
    }
    @media (max-width: 576px) {
      .col-md-4, .col-md-6, .col-12 {
        width: 100%; /* Empilha colunas em telas muito pequenas */
      }
      .btn-group-vertical {
        display: flex;
        flex-direction: column;
        gap: 5px; /* Espaçamento entre botões verticais */
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec" class="btn btn-secondary btn-back">← Voltar ao Menu Principal</a>
    
    <h1 class="mb-4">Controle de Investimentos</h1>

    <h2 class="mt-4">Cadastrar / Editar Investimento</h2>
    <form id="investmentForm" class="row g-3 needs-validation" novalidate>
      <input type="hidden" id="investId">
      <div class="col-md-6 col-sm-12">
        <label for="investName" class="form-label">Nome do Investimento</label>
        <input type="text" class="form-control" id="investName" required>
        <div class="invalid-feedback">Por favor, insira o nome do investimento.</div>
      </div>
      <div class="col-md-6 col-sm-12">
        <label for="investInstitution" class="form-label">Instituição</label>
        <input type="text" class="form-control" id="investInstitution" required>
        <div class="invalid-feedback">Por favor, insira a instituição.</div>
      </div>
      <div class="col-md-4 col-sm-6">
        <label for="investInitialValue" class="form-label">Valor Inicial (R$)</label>
        <input type="text" class="form-control" id="investInitialValue" required inputmode="numeric">
        <div class="invalid-feedback">Por favor, insira o valor inicial.</div>
      </div>
      <div class="col-md-4 col-sm-6">
        <label for="investCurrentValue" class="form-label">Valor Atual (R$)</label>
        <input type="text" class="form-control" id="investCurrentValue" readonly inputmode="numeric">
        <div class="form-text">Preenchido automaticamente ao salvar ou atualizar.</div>
      </div>
      <div class="col-md-4 col-sm-12">
        <label for="investType" class="form-label">Tipo</label>
        <select class="form-select" id="investType" required>
          <option value="">Selecione...</option>
          <option value="CDB">CDB</option>
          <option value="Fundo">Fundo</option>
          <option value="Ação">Ação</option>
          <option value="Tesouro Direto">Tesouro Direto</option>
          <option value="LCI/LCA">LCI/LCA</option>
          <option value="Outro">Outro</option>
        </select>
        <div class="invalid-feedback">Por favor, selecione o tipo.</div>
      </div>
      <div class="col-md-4 col-sm-6">
        <label for="investRentability" class="form-label">Rentabilidade (%)</label>
        <input type="number" step="0.01" class="form-control" id="investRentability" readonly>
        <div class="form-text">Calculado automaticamente.</div>
      </div>
      <div class="col-md-6 col-sm-12">
        <label for="investStartDate" class="form-label">Data do Aporte Inicial</label>
        <input type="date" class="form-control" id="investStartDate" required>
        <div class="invalid-feedback">Por favor, insira a data do aporte inicial.</div>
      </div>
      <div class="col-md-6 col-sm-12">
        <label for="investMovementType" class="form-label">Tipo de Aporte</label>
        <select class="form-select" id="investMovementType" required>
          <option value="">Selecione...</option>
          <option value="Único">Único</option>
          <option value="Recorrente">Recorrente</option>
        </select>
        <div class="invalid-feedback">Por favor, selecione o tipo de aporte.</div>
      </div>
      <div class="col-md-6 col-sm-12">
        <label for="investAutomationType" class="form-label">Tipo de Movimentação</label>
        <select class="form-select" id="investAutomationType" required>
          <option value="">Selecione...</option>
          <option value="Manual">Manual</option>
          <option value="Automático">Automático</option>
        </select>
        <div class="invalid-feedback">Por favor, selecione o tipo de movimentação.</div>
      </div>
      <div class="col-12">
        <label for="investObservations" class="form-label">Observações</label>
        <textarea class="form-control" id="investObservations" rows="2"></textarea>
      </div>
      <div class="col-12 mt-3">
        <button class="btn btn-primary" type="submit">Salvar Investimento</button>
        <button class="btn btn-secondary" type="button" id="clearFormBtn">Limpar Formulário</button>
        <div id="investmentMessage" class="mt-2"></div>
      </div>
    </form>

    <h3 class="mt-5">Meus Investimentos</h3>
    <div class="input-group mb-3">
        <input type="text" class="form-control" id="investSearch" placeholder="Buscar investimento...">
        <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn">Limpar</button>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Instituição</th>
            <th>Tipo</th>
            <th>Inicial</th>
            <th>Atual</th>
            <th>Rentab. (%)</th>
            <th>Aporte Inicial</th>
            <th>Tipo Aporte</th>
            <th>Movimento</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="investmentList">
          <tr><td colspan="10" class="text-center">Carregando investimentos...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="modal fade" id="updateValueModal" tabindex="-1" aria-labelledby="updateValueModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="updateValueModalLabel">Atualizar Valor do Investimento</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="updateValueForm" class="needs-validation" novalidate>
              <input type="hidden" id="modalInvestId">
              <p>Investimento: <strong id="modalInvestName"></strong></p>
              <p>Valor Atual Registrado: <strong id="modalInvestCurrentValue"></strong></p>

              <div class="mb-3">
                <label for="newInvestValue" class="form-label">Novo Valor Atual (R$)</label>
                <input type="text" class="form-control" id="newInvestValue" required inputmode="numeric">
                <div class="invalid-feedback">Por favor, insira o novo valor atual.</div>
              </div>
              <div class="mb-3">
                <label for="newInvestRentability" class="form-label">Nova Rentabilidade (%) (Opcional, será recalculado se valor inicial > 0)</label>
                <input type="number" step="0.01" class="form-control" id="newInvestRentability">
              </div>
              <button type="submit" class="btn btn-primary">Atualizar Valor</button>
              <div id="updateValueMessage" class="mt-2"></div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="movementModal" tabindex="-1" aria-labelledby="movementModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="movementModalLabel">Registrar Aporte / Resgate</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="movementForm" class="needs-validation" novalidate>
              <input type="hidden" id="modalMovementInvestId">
              <p>Investimento: <strong id="modalMovementInvestName"></strong></p>
              <div class="mb-3">
                <label for="movementDate" class="form-label">Data</label>
                <input type="date" class="form-control" id="movementDate" required>
                <div class="invalid-feedback">Por favor, insira a data.</div>
              </div>
              <div class="mb-3">
                <label for="movementType" class="form-label">Tipo de Transação</label>
                <select class="form-select" id="movementType" required>
                  <option value="">Selecione...</option>
                  <option value="Aporte">Aporte</option>
                  <option value="Resgate">Resgate</option>
                </select>
                <div class="invalid-feedback">Por favor, selecione o tipo.</div>
              </div>
              <div class="mb-3">
                <label for="movementValue" class="form-label">Valor (R$)</label>
                <input type="text" class="form-control" id="movementValue" required inputmode="numeric">
                <div class="invalid-feedback">Por favor, insira o valor.</div>
              </div>
              <div class="mb-3">
                <label for="movementAccount" class="form-label">Conta de Origem/Destino</label>
                <select class="form-select" id="movementAccount" required>
                  </select>
                <div class="invalid-feedback">Por favor, selecione a conta.</div>
              </div>
              <div class="mb-3">
                <label for="movementObservations" class="form-label">Observações</label>
                <textarea class="form-control" id="movementObservations" rows="2"></textarea>
              </div>
              <button type="submit" class="btn btn-primary">Registrar Movimentação</button>
              <div id="movementMessage" class="mt-2"></div>
            </form>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script> <script>
    $(document).ready(function() {
      // ATENÇÃO: Este é o URL base da sua Web App do Google Apps Script.
      // Se você fizer uma nova implantação ou o URL mudar por qualquer motivo,
      // VOCÊ DEVE ATUALIZAR ESTE URL EM TODOS OS ARQUIVOS HTML DO SEU PROJETO.
      // URL ATUAL: https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec
      const mainAppUrl = "https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec"; 
      $('.btn-back').attr('href', mainAppUrl);

      let allInvestments = []; // Para armazenar todos os investimentos para busca

      // Função auxiliar para formatar valor como moeda BRL para exibição (não para inputs mascarados)
      function formatCurrency(value) {
          if (typeof value !== 'number') {
              value = parseFloat(value);
          }
          if (isNaN(value)) {
              return 'R$ 0,00';
          }
          return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      }

      // Função auxiliar para limpar a formatação de um valor mascarado e obter o número
      function unmaskAndParseCurrency(maskedValue) {
          if (typeof maskedValue === 'string') {
              const cleanValue = maskedValue.replace(/[R$ ]/g, '').replace(/\./g, '').replace(/,/g, '.');
              return parseFloat(cleanValue);
          }
          return maskedValue; // Se já for um número, retorna como está
      }

      // APLICAR MÁSCARA NOS CAMPOS DE VALOR
      $('#investInitialValue, #investCurrentValue, #newInvestValue, #movementValue').mask('0.000.000.000.000,00', {reverse: true});


      // Carregar Investimentos
      function loadInvestments() {
        console.log("loadInvestments: Iniciando carregamento de investimentos.");
        google.script.run.withSuccessHandler(function(data) {
          console.log("loadInvestments: Dados de investimentos recebidos:", data);
          if (data && data.length > 0 && data[0] && Array.isArray(data[0])) {
            allInvestments = data.slice(1); // Ignora o cabeçalho
            renderInvestments(allInvestments);
            console.log("loadInvestments: Investimentos carregados e renderizados.");
          } else {
            console.warn("loadInvestments: Nenhum investimento ou dados de investimento inválidos recebidos.");
            $('#investmentList').html('<tr><td colspan="10" class="text-center text-muted">Nenhum investimento registrado ainda.</td></tr>');
          }
        }).withFailureHandler(function(error) {
            console.error("loadInvestments: Erro ao carregar investimentos do backend:", error.message);
            $('#investmentList').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar investimentos: ' + error.message + '</td></tr>');
        }).getSheetData('Investimentos');
      }

      function renderInvestments(investmentsToRender) {
        let html = '';
        if (investmentsToRender.length === 0) {
          html = '<tr><td colspan="10" class="text-center text-muted">Nenhum investimento registrado ainda.</td></tr>';
        } else {
            const headers = google.script.run.getSheetData('Investimentos')[0]; // Busca cabeçalhos novamente
            const idCol = headers.indexOf('ID');
            const nomeInvestimentoCol = headers.indexOf('Nome do Investimento');
            const instituicaoCol = headers.indexOf('Instituição');
            const valorInicialCol = headers.indexOf('Valor Inicial');
            const valorAtualCol = headers.indexOf('Valor Atual');
            const tipoCol = headers.indexOf('Tipo');
            const rentabilidadeCol = headers.indexOf('Rentabilidade %');
            const dataAporteInicialCol = headers.indexOf('Data Aporte Inicial');
            const observacoesCol = headers.indexOf('Observacoes');
            const tipoAporteCol = headers.indexOf('Tipo de Aporte'); 
            const tipoMovimentacaoCol = headers.indexOf('Tipo de Movimentação'); 


            if ([idCol, nomeInvestimentoCol, instituicaoCol, valorInicialCol, valorAtualCol, tipoCol, rentabilidadeCol, dataAporteInicialCol, observacoesCol].some(idx => idx === -1)) {
                console.error("renderInvestments: Cabeçalhos da aba 'Investimentos' inválidos. Verifique a estrutura. Headers:", headers);
                $('#investmentList').html('<tr><td colspan="10" class="text-center text-danger">Erro: Cabeçalhos da aba Investimentos incorretos.</td></tr>');
                return;
            }
            
            investmentsToRender.forEach(row => {
              const investId = row[idCol];
              const nome = row[nomeInvestimentoCol];
              const instituicao = row[instituicaoCol];
              const valorInicial = parseFloat(row[valorInicialCol] || 0);
              const valorAtual = parseFloat(row[valorAtualCol] || 0);
              const tipo = row[tipoCol];
              const rentabilidade = parseFloat(row[rentabilidadeCol] || 0);
              const dataAporte = new Date(row[dataAporteInicialCol]);
              const formattedDate = !isNaN(dataAporte.getTime()) ? dataAporte.toLocaleDateString('pt-BR') : 'N/A';
              const tipoAporte = tipoAporteCol !== -1 && row[tipoAporteCol] !== undefined ? row[tipoAporteCol] : 'N/A';
              const tipoMovimentacao = tipoMovimentacaoCol !== -1 && row[tipoMovimentacaoCol] !== undefined ? row[tipoMovimentacaoCol] : 'N/A';


              const rentabilidadeClass = rentabilidade >= 0 ? 'status-positive' : 'status-negative';

              html += `<tr>
                <td>${nome}</td>
                <td>${instituicao}</td>
                <td>${tipo}</td>
                <td>${formatCurrency(valorInicial)}</td>
                <td>${formatCurrency(valorAtual)}</td>
                <td class="${rentabilidadeClass}">${rentabilidade.toFixed(2)}%</td>
                <td>${formattedDate}</td>
                <td>${tipoAporte}</td>
                <td>${tipoMovimentacao}</td>
                <td>
                  <div class="btn-group-vertical" role="group" aria-label="Ações do Investimento">
                    <button class="btn btn-sm btn-info edit-invest-btn" data-id="${investId}">Editar</button>
                    <button class="btn btn-sm btn-primary update-value-btn" data-id="${investId}" data-name="${nome}" data-current-value="${valorAtual.toFixed(2)}">Atualizar Valor</button>
                    <button class="btn btn-sm btn-success record-movement-btn" data-id="${investId}" data-name="${nome}">Aporte/Resgate</button>
                    <button class="btn btn-sm btn-danger delete-invest-btn" data-id="${investId}" data-name="${nome}">Excluir</button>
                  </div>
                </td>
              </tr>`;
            });
          }
          $('#investmentList').html(html);
          console.log("renderInvestments: Investimentos renderizados na tabela.");

          // Adicionar listeners para botões de Editar
          $('.edit-invest-btn').on('click', function() {
            const investId = $(this).data('id');
            const rowData = allInvestments.find(row => row[idCol] === investId); 
            if (rowData) {
              $('#investId').val(rowData[idCol]);
              $('#investName').val(rowData[nomeInvestimentoCol]);
              $('#investInstitution').val(rowData[instituicaoCol]);
              
              const initialValueRaw = parseFloat(rowData[valorInicialCol] || 0);
              $('#investInitialValue').val(initialValueRaw); 
              $('#investInitialValue').mask('0.000.000.000.000,00', {reverse: true}).val(formatCurrency(initialValueRaw));

              const currentValueRaw = parseFloat(rowData[valorAtualCol] || 0);
              $('#investCurrentValue').val(currentValueRaw); 
              $('#investCurrentValue').mask('0.000.000.000.000,00', {reverse: true}).val(formatCurrency(currentValueRaw));
              
              $('#investType').val(rowData[tipoCol]);
              $('#investRentability').val(rowData[rentabilidadeCol]); // Preenche mas é readonly
              
              const startDate = new Date(rowData[dataAporteInicialCol]);
              $('#investStartDate').val(startDate.toISOString().split('T')[0]);
              
              $('#investMovementType').val(tipoAporteCol !== -1 && rowData[tipoAporteCol] !== undefined ? rowData[tipoAporteCol] : 'Único'); 
              $('#investAutomationType').val(tipoMovimentacaoCol !== -1 && rowData[tipoMovimentacaoCol] !== undefined ? rowData[tipoMovimentacaoCol] : 'Manual'); 

              $('#investObservations').val(rowData[observacoesCol]);
              console.log("edit-invest-btn: Formulário de investimento preenchido para edição.");
            }
          });

          // Event listener para o botão de Atualizar Valor (abre o modal)
          $('.update-value-btn').on('click', function() {
            const investId = $(this).data('id');
            const investName = $(this).data('name');
            const investCurrentValue = parseFloat($(this).data('current-value')); 
            
            $('#modalInvestId').val(investId);
            $('#modalInvestName').text(investName);
            $('#modalInvestCurrentValue').text(formatCurrency(investCurrentValue)); // Formatando no modal
            $('#newInvestValue').val(''); // Limpa o campo de valor
            $('#newInvestValue').mask('0.000.000.000.000,00', {reverse: true});
            $('#newInvestRentability').val(''); // Limpa a rentabilidade
            $('#updateValueMessage').empty(); // Limpa mensagens anteriores
            console.log("update-value-btn: Modal de atualização de valor aberto.");

            const updateValueModal = new bootstrap.Modal(document.getElementById('updateValueModal'));
            updateValueModal.show();
          });

          // Event listener para o botão de Registrar Aporte/Resgate
          $('.record-movement-btn').on('click', function() {
            const investId = $(this).data('id');
            const investName = $(this).data('name');

            $('#modalMovementInvestId').val(investId);
            $('#modalMovementInvestName').text(investName);
            $('#movementDate').val(new Date().toISOString().split('T')[0]); // Data de hoje
            $('#movementType').val('');
            $('#movementValue').val('');
            $('#movementValue').mask('0.000.000.000.000,00', {reverse: true});

            $('#movementAccount').val('');
            $('#movementObservations').val('');
            $('#movementMessage').empty();

            console.log("record-movement-btn: Carregando dropdowns para modal de movimentação.");
            google.script.run.withSuccessHandler(function(dropdownData) {
                console.log("record-movement-btn: Dados de dropdowns para movimentação recebidos:", dropdownData);
                const contasHeaders = dropdownData.contas[0];
                const contaNomeCol = contasHeaders.indexOf('Nome da Conta');
                const contaBancoCol = contasHeaders.indexOf('Banco');

                $('#movementAccount').empty().append('<option value="">Selecione...</option>');
                if (dropdownData.contas && dropdownData.contas.length > 0 && contasHeaders.length > 0) {
                    dropdownData.contas.slice(1).forEach(row => {
                        const nomeConta = row[contaNomeCol];
                        const banco = row[contaBancoCol];
                        if (nomeConta) {
                            $('#movementAccount').append(`<option value="${nomeConta}">${nomeConta} (${banco || 'N/A'})</option>`);
                        }
                    });
                    console.log("record-movement-btn: Dropdown de contas populado.");
                } else {
                    console.warn("record-movement-btn: Nenhuma conta ou dados de conta inválidos recebidos para o modal de movimentação.");
                    $('#movementAccount').append('<option value="">Nenhuma conta encontrada.</option>');
                }

                const movementModal = new bootstrap.Modal(document.getElementById('movementModal'));
                movementModal.show();
            }).withFailureHandler(function(error) {
                console.error("record-movement-btn: Erro ao carregar dados de dropdowns para movimentação:", error.message);
                $('#movementAccount').empty().append('<option value="">Erro ao carregar dados.</option>');
            }).getSheetDataBatch({
                contas: 'Contas'
            });
          });

          // Event listeners para botões de Excluir
          $('.delete-invest-btn').on('click', function() {
            const investId = $(this).data('id');
            const investName = $(this).data('name');
            if (confirm(`Tem certeza que deseja excluir o investimento "${investName}"?`)) {
              console.log("delete-invest-btn: Solicitando exclusão do investimento ID:", investId);
              google.script.run
                .withSuccessHandler(function(success) {
                  if (success) {
                    $('#investmentMessage').html('<div class="alert alert-success">Investimento excluído com sucesso!</div>');
                    loadInvestments();
                    $('#investmentForm')[0].reset(); 
                    $('#investId').val('');
                    $('#investmentForm').removeClass('was-validated');
                    $('#investInitialValue, #investCurrentValue').mask('0.000.000.000.000,00', {reverse: true});
                    console.log("delete-invest-btn: Investimento excluído com sucesso.");
                  } else {
                    $('#investmentMessage').html('<div class="alert alert-danger">Erro ao excluir investimento.</div>');
                    console.error("delete-invest-btn: Erro ao excluir investimento (backend retornou false).");
                  }
                })
                .withFailureHandler(function(error) {
                  $('#investmentMessage').html('<div class="alert alert-danger">Erro inesperado: ' + error.message + '</div>');
                  console.error("delete-invest-btn: Erro inesperado do backend ao excluir investimento:", error);
                })
                .deleteInvestment(investId);
            }
          });

        } // Fim do else (se houver dados)
      } // Fim da renderInvestments

      // Envio do formulário de Investimento
      $('#investmentForm').on('submit', function(event) {
        event.preventDefault();
        const form = $(this)[0];

        const investInitialValueParsed = unmaskAndParseCurrency($('#investInitialValue').val());
        $('#investInitialValue').val(investInitialValueParsed); 

        const investCurrentValueParsed = unmaskAndParseCurrency($('#investCurrentValue').val());
        $('#investCurrentValue').val(investCurrentValueParsed); 
        

        if (!form.checkValidity()) {
          event.stopPropagation();
          if (!isNaN(investInitialValueParsed)) {
              $('#investInitialValue').val(formatCurrency(investInitialValueParsed));
          }
          if (!isNaN(investCurrentValueParsed)) {
              $('#investCurrentValue').val(formatCurrency(investCurrentValueParsed));
          }
          console.warn("investmentForm: Formulário inválido.");

        } else {
          const investData = {
            id: $('#investId').val(),
            nomeInvestimento: $('#investName').val(),
            instituicao: $('#investInstitution').val(),
            valorInicial: parseFloat(investInitialValueParsed), 
            valorAtual: parseFloat(investCurrentValueParsed), 
            tipo: $('#investType').val(),
            rentabilidade: parseFloat($('#investRentability').val()), 
            dataAporteInicial: $('#investStartDate').val(),
            tipoAporte: $('#investMovementType').val(), 
            tipoMovimentacao: $('#investAutomationType').val(), 
            observacoes: $('#investObservations').val()
          };
          console.log("saveInvestment: Enviando dados:", investData);
          google.script.run
            .withSuccessHandler(function(success) {
              if (success) {
                $('#investmentMessage').html('<div class="alert alert-success">Investimento salvo/atualizado com sucesso!</div>');
                form.reset();
                form.classList.remove('was-validated');
                $('#investId').val('');
                $('#investInitialValue, #investCurrentValue').mask('0.000.000.000.000,00', {reverse: true});
                loadInvestments();
                console.log("saveInvestment: Investimento salvo/atualizado com sucesso.");
              } else {
                $('#investmentMessage').html('<div class="alert alert-danger">Erro ao salvar investimento. Verifique os logs.</div>');
                console.error("saveInvestment: Erro ao salvar investimento (backend retornou false).");
              }
            })
            .withFailureHandler(function(error) {
                $('#investmentMessage').html('<div class="alert alert-danger">Ocorreu um erro inesperado: ' + error.message + '</div>');
                console.error("saveInvestment: Erro inesperado do backend:", error);
            })
            .saveInvestment(investData);
        }
        form.classList.add('was-validated');
      });

      // Envio do formulário de Atualização de Valor (dentro do modal)
      $('#updateValueForm').on('submit', function(event) {
        event.preventDefault();
        const form = $(this)[0];

        const newInvestValueParsed = unmaskAndParseCurrency($('#newInvestValue').val());
        $('#newInvestValue').val(newInvestValueParsed); 
        

        if (!form.checkValidity()) {
          event.stopPropagation();
          if (!isNaN(newInvestValueParsed)) {
              $('#newInvestValue').val(formatCurrency(newInvestValueParsed));
          }
          console.warn("updateValueForm: Formulário inválido.");

        } else {
          const investId = $('#modalInvestId').val();
          const newInvestValue = parseFloat(newInvestValueParsed); 
          const newInvestRentability = $('#newInvestRentability').val() !== '' ? parseFloat($('#newInvestRentability').val()) : undefined;

          console.log("updateInvestmentValue: Enviando dados:", {investId, newInvestValue, newInvestRentability});
          google.script.run
            .withSuccessHandler(function(success) {
              if (success) {
                $('#updateValueMessage').html('<div class="alert alert-success">Valor atualizado com sucesso!</div>');
                setTimeout(() => {
                    $('#updateValueModal').modal('hide');
                    form.reset();
                    form.classList.remove('was-validated');
                    $('#newInvestValue').mask('0.000.000.000.000,00', {reverse: true});
                    loadInvestments();
                }, 1000);
                console.log("updateInvestmentValue: Valor atualizado com sucesso.");
              } else {
                $('#updateValueMessage').html('<div class="alert alert-danger">Erro ao atualizar valor. Verifique os logs.</div>');
                console.error("updateInvestmentValue: Erro ao atualizar valor (backend retornou false).");
              }
            })
            .withFailureHandler(function(error) {
                $('#updateValueMessage').html('<div class="alert alert-danger">Ocorreu um erro inesperado: ' + error.message + '</div>');
                console.error("updateInvestmentValue: Erro inesperado do backend:", error);
            })
            .updateInvestmentValue(investId, newInvestValue, newInvestRentability);
        }
        form.classList.add('was-validated');
      });

      // Envio do formulário de Registro de Aporte/Resgate (dentro do modal)
      $('#movementForm').on('submit', function(event) {
        event.preventDefault();
        const form = $(this)[0];

        const movementValueParsed = unmaskAndParseCurrency($('#movementValue').val());
        $('#movementValue').val(movementValueParsed); 
        

        if (!form.checkValidity()) {
          event.stopPropagation();
          if (!isNaN(movementValueParsed)) {
              $('#movementValue').val(formatCurrency(movementValueParsed));
          }
          console.warn("movementForm: Formulário inválido.");

        } else {
          const investId = $('#modalMovementInvestId').val();
          const movementData = {
            investId: investId,
            data: $('#movementDate').val(),
            tipo: $('#movementType').val(),
            valor: parseFloat(movementValueParsed), 
            conta: $('#movementAccount').val(),
            observacoes: $('#movementObservations').val()
          };
          console.log("recordInvestmentMovement: Enviando dados:", movementData);
          google.script.run
            .withSuccessHandler(function(success) {
              if (success) {
                $('#movementMessage').html('<div class="alert alert-success">Movimentação registrada com sucesso!</div>');
                setTimeout(() => {
                    $('#movementModal').modal('hide');
                    form.reset();
                    form.classList.remove('was-validated');
                    $('#movementValue').mask('0.000.000.000.000,00', {reverse: true});
                    loadInvestments(); 
                }, 1000);
                console.log("recordInvestmentMovement: Movimentação registrada com sucesso.");
              } else {
                $('#movementMessage').html('<div class="alert alert-danger">Erro ao registrar movimentação. Verifique os logs.</div>');
                console.error("recordInvestmentMovement: Erro ao registrar movimentação (backend retornou false).");
              }
            })
            .withFailureHandler(function(error) {
                $('#movementMessage').html('<div class="alert alert-danger">Ocorreu um erro inesperado: ' + error.message + '</div>');
                console.error("recordInvestmentMovement: Erro inesperado do backend:", error);
            })
            .recordInvestmentMovement(movementData); 
        }
        form.classList.add('was-validated');
      });

      // Limpar Formulário
      $('#clearFormBtn').on('click', function() {
        $('#investmentForm')[0].reset();
        $('#investmentForm').removeClass('was-validated');
        $('#investId').val(''); 
        $('#investmentMessage').empty();
        $('#investInitialValue, #investCurrentValue').mask('0.000.000.000.000,00', {reverse: true});
        console.log("clearFormBtn: Formulário de investimento limpo.");
      });

      // Busca parcial no campo de pesquisa
      $('#investSearch').on('keyup', function() {
        const searchTerm = $(this).val().toLowerCase();
        const filtered = allInvestments.filter(row => {
          const headers = google.script.run.getSheetData('Investimentos')[0];
          const nomeInvestimentoCol = headers.indexOf('Nome do Investimento');
          const instituicaoCol = headers.indexOf('Instituição');
          const tipoCol = headers.indexOf('Tipo');
          const tipoAporteCol = headers.indexOf('Tipo de Aporte'); 
          const tipoMovimentacaoCol = headers.indexOf('Tipo de Movimentação'); 
          
          return (row[nomeInvestimentoCol] && row[nomeInvestimentoCol].toLowerCase().includes(searchTerm)) ||
                 (row[instituicaoCol] && row[instituicaoCol].toLowerCase().includes(searchTerm)) ||
                 (row[tipoCol] && row[tipoCol].toLowerCase().includes(searchTerm)) ||
                 (tipoAporteCol !== -1 && row[tipoAporteCol] && row[tipoAporteCol].toLowerCase().includes(searchTerm)) || 
                 (tipoMovimentacaoCol !== -1 && row[tipoMovimentacaoCol] && row[tipoMovimentacaoCol].toLowerCase().includes(searchTerm)); 
        });
        renderInvestments(filtered);
        console.log("investSearch: Pesquisa de investimento executada.");
      });

      // Limpar Busca
      $('#clearSearchBtn').on('click', function() {
        $('#investSearch').val('');
        renderInvestments(allInvestments);
        console.log("clearSearchBtn: Pesquisa de investimento limpa.");
      });

      // Inicialização
      loadInvestments();

      // Ativa a validação do Bootstrap
      const forms = document.querySelectorAll('.needs-validation');
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    });
  </script>
</body>
</html>