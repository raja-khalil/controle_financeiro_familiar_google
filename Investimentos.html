<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Investimentos - Controle Financeiro Familiar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding-top: 20px; background-color: #f8f9fa; font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
    .container { max-width: 1000px; background-color: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.1); margin-bottom: 50px; }
    h1, h2, h3 { color: #343a40; }
    .btn-back { margin-bottom: 20px; }
    .table thead th { background-color: #e9ecef; color: #495057; border-bottom: 2px solid #dee2e6; }
    .table tbody tr:hover { background-color: #f2f2f2; }
    .alert-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
    .alert-danger { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
    .status-positive { color: #28a745; font-weight: bold; } /* Bootstrap green */
    .status-negative { color: #dc3545; font-weight: bold; } /* Bootstrap red */
  </style>
</head>
<body>
  <div class="container">
    <a href="https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec" class="btn btn-secondary btn-back">← Voltar ao Menu Principal</a>
    
    <h1 class="mb-4">Controle de Investimentos</h1>

    <h2 class="mt-4">Cadastrar / Editar Investimento</h2>
    <form id="investmentForm" class="row g-3 needs-validation" novalidate>
      <input type="hidden" id="investId">
      <div class="col-md-6">
        <label for="investName" class="form-label">Nome do Investimento</label>
        <input type="text" class="form-control" id="investName" required>
        <div class="invalid-feedback">Por favor, insira o nome do investimento.</div>
      </div>
      <div class="col-md-6">
        <label for="investInstitution" class="form-label">Instituição</label>
        <input type="text" class="form-control" id="investInstitution" required>
        <div class="invalid-feedback">Por favor, insira a instituição.</div>
      </div>
      <div class="col-md-4">
        <label for="investInitialValue" class="form-label">Valor Inicial (R$)</label>
        <input type="number" step="0.01" class="form-control" id="investInitialValue" required>
        <div class="invalid-feedback">Por favor, insira o valor inicial.</div>
      </div>
      <div class="col-md-4">
        <label for="investCurrentValue" class="form-label">Valor Atual (R$)</label>
        <input type="number" step="0.01" class="form-control" id="investCurrentValue" readonly>
        <div class="form-text">Preenchido automaticamente ao salvar ou atualizar.</div>
      </div>
      <div class="col-md-4">
        <label for="investType" class="form-label">Tipo</label>
        <select class="form-select" id="investType" required>
          <option value="">Selecione...</option>
          <option value="CDB">CDB</option>
          <option value="Fundo">Fundo</option>
          <option value="Ação">Ação</option>
          <option value="Tesouro Direto">Tesouro Direto</option>
          <option value="LCI/LCA">LCI/LCA</option>
          <option value="Outro">Outro</option>
        </select>
        <div class="invalid-feedback">Por favor, selecione o tipo.</div>
      </div>
      <div class="col-md-4">
        <label for="investRentability" class="form-label">Rentabilidade (%)</label>
        <input type="number" step="0.01" class="form-control" id="investRentability" readonly>
        <div class="form-text">Calculado automaticamente.</div>
      </div>
      <div class="col-md-6">
        <label for="investStartDate" class="form-label">Data do Aporte Inicial</label>
        <input type="date" class="form-control" id="investStartDate" required>
        <div class="invalid-feedback">Por favor, insira a data do aporte inicial.</div>
      </div>
      <div class="col-12">
        <label for="investObservations" class="form-label">Observações</label>
        <textarea class="form-control" id="investObservations" rows="2"></textarea>
      </div>
      <div class="col-12 mt-3">
        <button class="btn btn-primary" type="submit">Salvar Investimento</button>
        <div id="investmentMessage" class="mt-2"></div>
      </div>
    </form>

    <h3 class="mt-5">Meus Investimentos</h3>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Instituição</th>
            <th>Tipo</th>
            <th>Valor Inicial</th>
            <th>Valor Atual</th>
            <th>Rentabilidade (%)</th>
            <th>Data Aporte</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="investmentList">
          <tr><td colspan="8" class="text-center">Carregando investimentos...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="modal fade" id="updateValueModal" tabindex="-1" aria-labelledby="updateValueModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="updateValueModalLabel">Atualizar Valor do Investimento</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="updateValueForm" class="needs-validation" novalidate>
              <input type="hidden" id="modalInvestId">
              <p>Investimento: <strong id="modalInvestName"></strong></p>
              <p>Valor Atual Registrado: <strong id="modalInvestCurrentValue"></strong></p>

              <div class="mb-3">
                <label for="newInvestValue" class="form-label">Novo Valor Atual (R$)</label>
                <input type="number" step="0.01" class="form-control" id="newInvestValue" required>
                <div class="invalid-feedback">Por favor, insira o novo valor atual.</div>
              </div>
              <div class="mb-3">
                <label for="newInvestRentability" class="form-label">Nova Rentabilidade (%) (Opcional, será recalculado se valor inicial > 0)</label>
                <input type="number" step="0.01" class="form-control" id="newInvestRentability">
              </div>
              <button type="submit" class="btn btn-primary">Atualizar Valor</button>
              <div id="updateValueMessage" class="mt-2"></div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="movementModal" tabindex="-1" aria-labelledby="movementModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="movementModalLabel">Registrar Aporte / Resgate</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="movementForm" class="needs-validation" novalidate>
              <input type="hidden" id="modalMovementInvestId">
              <p>Investimento: <strong id="modalMovementInvestName"></strong></p>
              <div class="mb-3">
                <label for="movementDate" class="form-label">Data</label>
                <input type="date" class="form-control" id="movementDate" required>
                <div class="invalid-feedback">Por favor, insira a data.</div>
              </div>
              <div class="mb-3">
                <label for="movementType" class="form-label">Tipo de Transação</label>
                <select class="form-select" id="movementType" required>
                  <option value="">Selecione...</option>
                  <option value="Aporte">Aporte</option>
                  <option value="Resgate">Resgate</option>
                </select>
                <div class="invalid-feedback">Por favor, selecione o tipo.</div>
              </div>
              <div class="mb-3">
                <label for="movementValue" class="form-label">Valor (R$)</label>
                <input type="number" step="0.01" class="form-control" id="movementValue" required>
                <div class="invalid-feedback">Por favor, insira o valor.</div>
              </div>
              <div class="mb-3">
                <label for="movementAccount" class="form-label">Conta de Origem/Destino</label>
                <select class="form-select" id="movementAccount" required>
                  </select>
                <div class="invalid-feedback">Por favor, selecione a conta.</div>
              </div>
              <div class="mb-3">
                <label for="movementObservations" class="form-label">Observações</label>
                <textarea class="form-control" id="movementObservations" rows="2"></textarea>
              </div>
              <button type="submit" class="btn btn-primary">Registrar Movimentação</button>
              <div id="movementMessage" class="mt-2"></div>
            </form>
          </div>
        </div>
      </div>
    </div>


  </div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

  <script>
    $(document).ready(function() {
      // URL da Web App já inserido aqui
      const mainAppUrl = "https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec"; 
      $('.btn-back').attr('href', mainAppUrl);

      // Carregar Investimentos
      function loadInvestments() {
        google.script.run.withSuccessHandler(function(data) {
          let html = '';
          if (data.length <= 1) {
            html = '<tr><td colspan="8" class="text-center text-muted">Nenhum investimento registrado ainda.</td></tr>';
          } else {
            const headers = data[0];
            const idCol = headers.indexOf('ID');
            const nomeInvestimentoCol = headers.indexOf('Nome do Investimento');
            const instituicaoCol = headers.indexOf('Instituição');
            const valorInicialCol = headers.indexOf('Valor Inicial');
            const valorAtualCol = headers.indexOf('Valor Atual');
            const tipoCol = headers.indexOf('Tipo');
            const rentabilidadeCol = headers.indexOf('Rentabilidade %');
            const dataAporteInicialCol = headers.indexOf('Data Aporte Inicial');
            const observacoesCol = headers.indexOf('Observacoes');

            if ([idCol, nomeInvestimentoCol, instituicaoCol, valorInicialCol, valorAtualCol, tipoCol, rentabilidadeCol, dataAporteInicialCol, observacoesCol].some(idx => idx === -1)) {
                console.error("Cabeçalhos da aba 'Investimentos' inválidos. Verifique a estrutura.");
                $('#investmentList').html('<tr><td colspan="8" class="text-center text-danger">Erro: Cabeçalhos da aba Investimentos incorretos.</td></tr>');
                return;
            }
            
            data.slice(1).forEach(row => {
              const investId = row[idCol];
              const nome = row[nomeInvestimentoCol];
              const instituicao = row[instituicaoCol];
              const valorInicial = parseFloat(row[valorInicialCol] || 0);
              const valorAtual = parseFloat(row[valorAtualCol] || 0);
              const tipo = row[tipoCol];
              const rentabilidade = parseFloat(row[rentabilidadeCol] || 0);
              const dataAporte = new Date(row[dataAporteInicialCol]);
              const formattedDate = !isNaN(dataAporte.getTime()) ? dataAporte.toLocaleDateString('pt-BR') : 'N/A';

              const rentabilidadeClass = rentabilidade >= 0 ? 'status-positive' : 'status-negative';

              html += `<tr>
                <td>${nome}</td>
                <td>${instituicao}</td>
                <td>${tipo}</td>
                <td>R$ ${valorInicial.toFixed(2)}</td>
                <td>R$ ${valorAtual.toFixed(2)}</td>
                <td class="${rentabilidadeClass}">${rentabilidade.toFixed(2)}%</td>
                <td>${formattedDate}</td>
                <td>
                  <button class="btn btn-sm btn-info edit-invest-btn" data-id="${investId}">Editar</button>
                  <button class="btn btn-sm btn-primary update-value-btn" data-id="${investId}" data-name="${nome}" data-current-value="${valorAtual.toFixed(2)}">Atualizar Valor</button>
                  <button class="btn btn-sm btn-success record-movement-btn" data-id="${investId}" data-name="${nome}">Registrar Aporte/Resgate</button>
                </td>
              </tr>`;
            });
          }
          $('#investmentList').html(html);

          // Event listener para o botão de Editar Investimento
          $('.edit-invest-btn').on('click', function() {
            const investId = $(this).data('id');
            const rowData = data.slice(1).find(row => row[idCol] === investId); 
            if (rowData) {
              $('#investId').val(rowData[idCol]);
              $('#investName').val(rowData[nomeInvestimentoCol]);
              $('#investInstitution').val(rowData[instituicaoCol]);
              $('#investInitialValue').val(rowData[valorInicialCol]);
              $('#investCurrentValue').val(rowData[valorAtualCol]); // Preenche mas é readonly
              $('#investType').val(rowData[tipoCol]);
              $('#investRentability').val(rowData[rentabilidadeCol]); // Preenche mas é readonly
              
              const startDate = new Date(rowData[dataAporteInicialCol]);
              $('#investStartDate').val(startDate.toISOString().split('T')[0]);
              
              $('#investObservations').val(rowData[observacoesCol]);
            }
          });

          // Event listener para o botão de Atualizar Valor (abre o modal)
          $('.update-value-btn').on('click', function() {
            const investId = $(this).data('id');
            const investName = $(this).data('name');
            const investCurrentValue = $(this).data('current-value');
            
            $('#modalInvestId').val(investId);
            $('#modalInvestName').text(investName);
            $('#modalInvestCurrentValue').text(`R$ ${investCurrentValue}`);
            $('#newInvestValue').val(''); // Limpa o campo de valor
            $('#newInvestRentability').val(''); // Limpa a rentabilidade
            $('#updateValueMessage').empty(); // Limpa mensagens anteriores

            const updateValueModal = new bootstrap.Modal(document.getElementById('updateValueModal'));
            updateValueModal.show();
          });

          // Event listener para o botão de Registrar Aporte/Resgate
          $('.record-movement-btn').on('click', function() {
            const investId = $(this).data('id');
            const investName = $(this).data('name');

            $('#modalMovementInvestId').val(investId);
            $('#modalMovementInvestName').text(investName);
            $('#movementDate').val(new Date().toISOString().split('T')[0]); // Data de hoje
            $('#movementType').val('');
            $('#movementValue').val('');
            $('#movementAccount').val('');
            $('#movementObservations').val('');
            $('#movementMessage').empty();

            // Carrega dropdowns de contas para o modal
            google.script.run.withSuccessHandler(function(dropdownData) {
                const contasHeaders = dropdownData.contas[0];
                const contaNomeCol = contasHeaders.indexOf('Nome da Conta');
                const contaBancoCol = contasHeaders.indexOf('Banco');

                $('#movementAccount').empty().append('<option value="">Selecione...</option>');
                dropdownData.contas.slice(1).forEach(row => {
                    $('#movementAccount').append(`<option value="${row[contaNomeCol]}">${row[contaNomeCol]} (${row[contaBancoCol] || 'N/A'})</option>`);
                });

                const movementModal = new bootstrap.Modal(document.getElementById('movementModal'));
                movementModal.show();
            }).getSheetDataBatch({
                contas: 'Contas'
            });
          });

        }).getSheetData('Investimentos');
      }

      // Envio do formulário de Investimento
      $('#investmentForm').on('submit', function(event) {
        event.preventDefault();
        const form = $(this)[0];
        if (!form.checkValidity()) {
          event.stopPropagation();
        } else {
          const investData = {
            id: $('#investId').val(),
            nomeInvestimento: $('#investName').val(),
            instituicao: $('#investInstitution').val(),
            valorInicial: parseFloat($('#investInitialValue').val()),
            valorAtual: parseFloat($('#investCurrentValue').val()), // Será ignorado se for nova, usado para edição
            tipo: $('#investType').val(),
            rentabilidade: parseFloat($('#investRentability').val()), // Será ignorado se for nova, usado para edição
            dataAporteInicial: $('#investStartDate').val(),
            observacoes: $('#investObservations').val()
          };
          google.script.run
            .withSuccessHandler(function(success) {
              if (success) {
                $('#investmentMessage').html('<div class="alert alert-success">Investimento salvo/atualizado com sucesso!</div>');
                form.reset();
                form.classList.remove('was-validated');
                $('#investId').val('');
                loadInvestments();
              } else {
                $('#investmentMessage').html('<div class="alert alert-danger">Erro ao salvar investimento. Verifique os logs.</div>');
              }
            })
            .withFailureHandler(function(error) {
                $('#investmentMessage').html('<div class="alert alert-danger">Ocorreu um erro inesperado: ' + error.message + '</div>');
                console.error("Erro ao salvar investimento:", error);
            })
            .saveInvestment(investData);
        }
        form.classList.add('was-validated');
      });

      // Envio do formulário de Atualização de Valor (dentro do modal)
      $('#updateValueForm').on('submit', function(event) {
        event.preventDefault();
        const form = $(this)[0];
        if (!form.checkValidity()) {
          event.stopPropagation();
        } else {
          const investId = $('#modalInvestId').val();
          const newInvestValue = parseFloat($('#newInvestValue').val());
          const newInvestRentability = $('#newInvestRentability').val() !== '' ? parseFloat($('#newInvestRentability').val()) : undefined;

          google.script.run
            .withSuccessHandler(function(success) {
              if (success) {
                $('#updateValueMessage').html('<div class="alert alert-success">Valor atualizado com sucesso!</div>');
                setTimeout(() => {
                    $('#updateValueModal').modal('hide');
                    form.reset();
                    form.classList.remove('was-validated');
                    loadInvestments();
                }, 1000);
              } else {
                $('#updateValueMessage').html('<div class="alert alert-danger">Erro ao atualizar valor. Verifique os logs.</div>');
              }
            })
            .withFailureHandler(function(error) {
                $('#updateValueMessage').html('<div class="alert alert-danger">Ocorreu um erro inesperado: ' + error.message + '</div>');
                console.error("Erro ao atualizar valor:", error);
            })
            .updateInvestmentValue(investId, newInvestValue, newInvestRentability);
        }
        form.classList.add('was-validated');
      });

      // Envio do formulário de Registro de Aporte/Resgate (dentro do modal)
      $('#movementForm').on('submit', function(event) {
        event.preventDefault();
        const form = $(this)[0];
        if (!form.checkValidity()) {
          event.stopPropagation();
        } else {
          const investId = $('#modalMovementInvestId').val();
          const movementData = {
            investId: investId,
            data: $('#movementDate').val(),
            tipo: $('#movementType').val(),
            valor: parseFloat($('#movementValue').val()),
            conta: $('#movementAccount').val(),
            observacoes: $('#movementObservations').val()
          };

          google.script.run
            .withSuccessHandler(function(success) {
              if (success) {
                $('#movementMessage').html('<div class="alert alert-success">Movimentação registrada com sucesso!</div>');
                setTimeout(() => {
                    $('#movementModal').modal('hide');
                    form.reset();
                    form.classList.remove('was-validated');
                    loadInvestments(); // Recarrega investimentos para refletir o novo valor atualizado
                }, 1000);
              } else {
                $('#movementMessage').html('<div class="alert alert-danger">Erro ao registrar movimentação. Verifique os logs.</div>');
              }
            })
            .withFailureHandler(function(error) {
                $('#movementMessage').html('<div class="alert alert-danger">Ocorreu um erro inesperado: ' + error.message + '</div>');
                console.error("Erro ao registrar movimentação:", error);
            })
            .recordInvestmentMovement(movementData); // Chamada para a nova função no backend
        }
        form.classList.add('was-validated');
      });


      // Inicialização
      loadInvestments();

      // Ativa a validação do Bootstrap
      const forms = document.querySelectorAll('.needs-validation');
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    });
  </script>
</body>
</html>