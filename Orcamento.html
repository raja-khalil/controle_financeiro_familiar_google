<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Orçamento - Controle Financeiro Familiar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding-top: 20px; background-color: #f8f9fa; font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
    .container { max-width: 1000px; background-color: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.1); margin-bottom: 50px; }
    h1, h2, h3 { color: #343a40; }
    .btn-back { margin-bottom: 20px; }
    .table thead th { background-color: #e9ecef; color: #495057; border-bottom: 2px solid #dee2e6; }
    .table tbody tr:hover { background-color: #f2f2f2; }
    .alert-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
    .alert-danger { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
    .alert-info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
  </style>
</head>
<body>
  <div class="container">
    <a href="https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec" class="btn btn-secondary btn-back">← Voltar ao Menu Principal</a>
    
    <h1 class="mb-4">Orçamento Mensal</h1>

    <h2 class="mt-4">Definir Orçamento por Produto/Serviço</h2>
    <form id="budgetForm" class="row g-3 needs-validation" novalidate>
      <div class="col-md-4">
        <label for="budgetAnoMes" class="form-label">Mês/Ano</label>
        <input type="month" class="form-control" id="budgetAnoMes" required>
        <div class="invalid-feedback">Por favor, selecione o mês e ano.</div>
      </div>
      <div class="col-md-4">
        <label for="budgetCategory" class="form-label">Categoria</label>
        <select class="form-select" id="budgetCategory" required>
          </select>
        <div class="invalid-feedback">Por favor, selecione a categoria.</div>
      </div>
      <div class="col-md-4">
        <label for="budgetProductService" class="form-label">Produto/Serviço</label>
        <input type="text" class="form-control" id="budgetProductService" required placeholder="Ex: Aluguel, Supermercado">
        <div class="invalid-feedback">Por favor, insira o produto ou serviço.</div>
      </div>
      <div class="col-md-4">
        <label for="budgetValue" class="form-label">Valor Orçado (R$)</label>
        <input type="number" step="0.01" class="form-control" id="budgetValue" required>
        <div class="invalid-feedback">Por favor, insira o valor orçado.</div>
      </div>
      <div class="col-12 mt-3">
        <button class="btn btn-primary" type="submit">Salvar Orçamento</button>
        <div id="budgetMessage" class="mt-2"></div>
      </div>
    </form>

    <h2 class="mt-5">Análise de Orçamento Mensal por Categoria</h2>
    <p>Selecione um mês para ver a comparação entre o orçado e o gasto real por **categoria**.</p>
    <div class="col-md-3 mb-3">
      <label for="analysisAnoMes" class="form-label">Mês/Ano para Análise</label>
      <input type="month" class="form-control" id="analysisAnoMes">
    </div>
    <button class="btn btn-info mb-3" id="loadBudgetAnalysis">Carregar Análise</button>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Valor Orçado</th>
            <th>Valor Gasto</th>
            <th>Diferença</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="budgetAnalysisTable">
          <tr><td colspan="5" class="text-center">Selecione um mês para carregar a análise.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

  <script>
    $(document).ready(function() {
      // URL da Web App já inserido aqui
      const mainAppUrl = "https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec"; 
      $('.btn-back').attr('href', mainAppUrl);

      // Função para carregar dados das categorias para o dropdown de orçamento
      function loadCategoriesForBudget() {
        google.script.run.withSuccessHandler(function(data) {
          const categoriasData = data.categorias;
          const categoriaHeaders = categoriasData[0];
          const categoriaNomeCol = categoriaHeaders.indexOf('Nome da Categoria');

          if (categoriaNomeCol !== -1) {
            $('#budgetCategory').empty().append('<option value="">Selecione...</option>');
            categoriasData.slice(1).forEach(row => { // Ignora cabeçalho
              $('#budgetCategory').append(`<option value="${row[categoriaNomeCol]}">${row[categoriaNomeCol]}</option>`);
            });
          } else {
            console.error("Cabeçalhos de categorias para orçamento inválidos.");
          }
        }).getSheetDataBatch({
          categorias: 'Categorias'
        });
      }

      // Envio de Orçamento (AJUSTADO PARA INCLUIR Produto/Serviço)
      $('#budgetForm').on('submit', function(event) {
        event.preventDefault();
        const form = $(this)[0];
        if (!form.checkValidity()) {
          event.stopPropagation();
        } else {
          const budgetData = {
            anoMes: $('#budgetAnoMes').val(),
            categoria: $('#budgetCategory').val(),
            produtoServico: $('#budgetProductService').val(), // NOVO CAMPO
            valorOrcado: parseFloat($('#budgetValue').val())
          };
          google.script.run
            .withSuccessHandler(function(success) {
              if (success) {
                $('#budgetMessage').html('<div class="alert alert-success">Orçamento salvo/atualizado com sucesso!</div>');
                form.reset();
                form.classList.remove('was-validated');
                // Se a análise de orçamento estiver visível e for para o mesmo mês, recarrega-a
                if ($('#analysisAnoMes').val() && $('#analysisAnoMes').val() === budgetData.anoMes) {
                    $('#loadBudgetAnalysis').click();
                }
              } else {
                $('#budgetMessage').html('<div class="alert alert-danger">Erro ao salvar orçamento. Verifique os logs.</div>');
              }
            })
            .withFailureHandler(function(error) {
                $('#budgetMessage').html('<div class="alert alert-danger">Ocorreu um erro inesperado: ' + error.message + '</div>');
                console.error("Erro ao salvar orçamento:", error);
            })
            .saveBudget(budgetData);
        }
        form.classList.add('was-validated');
      });

      // Carregar Análise de Orçamento (NÃO PRECISA DE MUITA ALTERAÇÃO NO FRONT)
      $('#loadBudgetAnalysis').on('click', function() {
        const anoMes = $('#analysisAnoMes').val();
        if (!anoMes) {
          alert('Por favor, selecione um mês e ano para a análise do orçamento.');
          return;
        }
        google.script.run
          .withSuccessHandler(function(data) {
            let html = '';
            if (data.length === 0) {
              html = '<tr><td colspan="5" class="text-center text-muted">Nenhum dado de orçamento ou gasto para o mês selecionado.</td></tr>';
            } else {
              data.forEach(item => {
                const diferenca = item.orcado - item.gasto;
                let statusText = 'OK';
                let statusClass = 'text-success';
                if (diferenca < 0) {
                    statusText = 'Estourou o Orçamento';
                    statusClass = 'text-danger';
                } else if (diferenca > 0) {
                    statusText = 'Sobrando';
                    statusClass = 'text-info';
                }

                html += `<tr>
                  <td>${item.categoria}</td>
                  <td>R$ ${item.orcado.toFixed(2)}</td>
                  <td>R$ ${item.gasto.toFixed(2)}</td>
                  <td class="${diferenca >= 0 ? 'text-success' : 'text-danger'}">R$ ${diferenca.toFixed(2)}</td>
                  <td class="${statusClass}">${statusText}</td>
                </tr>`;
              });
            }
            $('#budgetAnalysisTable').html(html);
          })
          .withFailureHandler(function(error) {
              $('#budgetAnalysisTable').html('<tr><td colspan="5" class="text-center text-danger">Erro ao carregar análise: ' + error.message + '</td></tr>');
              console.error("Erro na análise de orçamento:", error);
          })
          .getBudgetAnalysis(anoMes);
      });

      // Inicialização
      loadCategoriesForBudget();

      // Ativa a validação do Bootstrap
      const forms = document.querySelectorAll('.needs-validation');
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    });
  </script>
</body>
</html>