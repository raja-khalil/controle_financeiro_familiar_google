<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Orçamento - Controle Financeiro Familiar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    body {
      padding-top: 20px;
      background-color: #f0f2f5; /* Fundo suave */
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    .container {
      max-width: 1000px;
      background-color: #ffffff;
      padding: 30px;
      border-radius: 12px; /* Cantos arredondados */
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); /* Sombra suave */
      margin-bottom: 50px;
    }
    h1, h2, h3 {
      color: #343a40;
      margin-bottom: 25px; /* Espaçamento padrão */
      font-weight: 600;
    }
    .btn-back {
      margin-bottom: 20px;
      background-color: #6c757d; /* Cinza do Bootstrap */
      border-color: #6c757d;
      transition: all 0.3s ease;
    }
    .btn-back:hover {
      background-color: #5a6268;
      border-color: #545b62;
      transform: translateY(-1px);
    }
    .form-label {
      font-weight: 500;
      color: #495057;
    }
    .form-control, .form-select {
      border-radius: 8px;
      border: 1px solid #ced4da;
      padding: 0.75rem 1rem;
    }
    .form-control:focus, .form-select:focus {
      border-color: #80bdff;
      box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
    }
    .btn-primary, .btn-info {
      border-radius: 8px;
      padding: 0.75rem 1.25rem;
      transition: all 0.3s ease;
    }
    .btn-primary {
      background-color: #007bff;
      border-color: #007bff;
    }
    .btn-primary:hover {
      background-color: #0056b3;
      border-color: #0056b3;
      transform: translateY(-1px);
    }
    .btn-info {
        background-color: #17a2b8;
        border-color: #17a2b8;
        color: #fff;
    }
    .btn-info:hover {
        background-color: #117a8b;
        border-color: #10707f;
        transform: translateY(-1px);
    }
    .table thead th {
      background-color: #e9ecef;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
      padding: 1rem;
    }
    .table tbody tr:hover {
      background-color: #f2f2f2;
    }
    .table td {
      vertical-align: middle;
      padding: 0.75rem;
    }
    .alert-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; border-radius: 8px; }
    .alert-danger { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; border-radius: 8px; }
    .alert-info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; border-radius: 8px; }
    .text-success { color: #28a745 !important; font-weight: 500; }
    .text-danger { color: #dc3545 !important; font-weight: 500; }

    /* Media queries para responsividade */
    @media (max-width: 768px) {
      .container {
        padding: 20px;
        border-radius: 8px;
      }
      h1, h2, h3 {
        font-size: 1.5em;
        margin-bottom: 20px;
      }
      .form-control, .form-select {
        padding: 0.6rem 0.8rem;
        font-size: 0.9rem;
      }
      .btn-primary, .btn-info {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
      }
      .table th, .table td {
        padding: 0.6rem;
        font-size: 0.85rem;
      }
    }
    @media (max-width: 576px) {
      .col-md-4, .col-md-6, .col-12 {
        width: 100%; /* Empilha colunas em telas muito pequenas */
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec" class="btn btn-secondary btn-back">← Voltar ao Menu Principal</a>
    
    <h1 class="mb-4">Orçamento Mensal</h1>

    <h2 class="mt-4">Definir Orçamento por Produto/Serviço</h2>
    <form id="budgetForm" class="row g-3 needs-validation" novalidate>
      <div class="col-md-4 col-sm-6">
        <label for="budgetAnoMes" class="form-label">Mês/Ano</label>
        <input type="month" class="form-control" id="budgetAnoMes" required>
        <div class="invalid-feedback">Por favor, selecione o mês e ano.</div>
      </div>
      <div class="col-md-4 col-sm-6">
        <label for="budgetType" class="form-label">Tipo de Orçamento</label>
        <select class="form-select" id="budgetType" required>
          <option value="">Selecione...</option>
          <option value="Receita">Receita</option>
          <option value="Despesa">Despesa</option>
        </select>
        <div class="invalid-feedback">Por favor, selecione o tipo.</div>
      </div>
      <div class="col-md-4 col-sm-12">
        <label for="budgetCategory" class="form-label">Categoria</label>
        <select class="form-select" id="budgetCategory" required>
          </select>
        <div class="invalid-feedback">Por favor, selecione a categoria.</div>
      </div>
      <div class="col-md-8 col-sm-12">
        <label for="budgetProductService" class="form-label">Produto/Serviço</label>
        <input type="text" class="form-control" id="budgetProductService" required placeholder="Ex: Aluguel, Supermercado, Salário">
        <div class="invalid-feedback">Por favor, insira o produto ou serviço.</div>
      </div>
      <div class="col-md-4 col-sm-12">
        <label for="budgetValue" class="form-label">Valor Orçado (R$)</label>
        <input type="text" class="form-control" id="budgetValue" required inputmode="numeric">
        <div class="invalid-feedback">Por favor, insira o valor orçado.</div>
      </div>
      <div class="col-12 mt-3">
        <button class="btn btn-primary" type="submit">Salvar Orçamento</button>
        <div id="budgetMessage" class="mt-2"></div>
      </div>
    </form>

    <h2 class="mt-5">Análise de Orçamento Mensal por Categoria</h2>
    <p class="text-muted">Selecione um mês para ver a comparação entre o orçado e o gasto/realizado por **categoria**.</p>
    <div class="row mb-3 align-items-end">
      <div class="col-md-4 col-sm-6">
        <label for="analysisAnoMes" class="form-label">Mês/Ano para Análise</label>
        <input type="month" class="form-control" id="analysisAnoMes">
      </div>
      <div class="col-md-4 col-sm-6 mt-3 mt-sm-0">
        <button class="btn btn-info w-100" id="loadBudgetAnalysis">Carregar Análise</button>
      </div>
    </div>

    <h3 class="mt-4">Resumo de Receitas</h3>
    <div class="table-responsive mb-5">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Valor Estimado</th>
            <th>Valor Realizado</th>
            <th>Diferença</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="budgetAnalysisTableReceitas">
          <tr><td colspan="5" class="text-center">Selecione um mês para carregar a análise de receitas.</td></tr>
        </tbody>
      </table>
    </div>

    <h3 class="mt-4">Resumo de Despesas</h3>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Valor Orçado</th>
            <th>Valor Gasto</th>
            <th>Diferença</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="budgetAnalysisTableDespesas">
          <tr><td colspan="5" class="text-center">Selecione um mês para carregar a análise de despesas.</td></tr>
        </tbody>
      </table>
    </div>


  </div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script> <script>
    $(document).ready(function() {
      // ATENÇÃO: Este é o URL base da sua Web App do Google Apps Script.
      // Se você fizer uma nova implantação ou o URL mudar por qualquer motivo,
      // VOCÊ DEVE ATUALIZAR ESTE URL EM TODOS OS ARQUIVOS HTML DO SEU PROJETO.
      // URL ATUAL: https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec
      const mainAppUrl = "https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec"; 
      $('.btn-back').attr('href', mainAppUrl);

      let allCategoriesData = []; // Para armazenar todas as categorias

      // Função auxiliar para formatar valor como moeda BRL para exibição (não para inputs mascarados)
      function formatCurrency(value) {
          if (typeof value !== 'number') {
              value = parseFloat(value);
          }
          if (isNaN(value)) {
              return 'R$ 0,00';
          }
          return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      }

      // Função auxiliar para limpar a formatação de um valor mascarado e obter o número
      function unmaskAndParseCurrency(maskedValue) {
          if (typeof maskedValue === 'string') {
              // Remove todos os caracteres não numéricos, exceto a vírgula para a decimal,
              // depois substitui a vírgula por ponto para parseFloat.
              const cleanValue = maskedValue.replace(/[R$ ]/g, '').replace(/\./g, '').replace(/,/g, '.');
              return parseFloat(cleanValue);
          }
          return maskedValue; // Se já for um número, retorna como está
      }

      // APLICAR MÁSCARA NOS CAMPOS DE VALOR
      $('#budgetValue').mask('0.000.000.000.000,00', {reverse: true});
      // Importante: para campos já preenchidos (ex: em edição), você precisaria:
      // $('#budgetValue').val(valorPuro).mask('0.000.000.000.000,00', {reverse: true});


      // Função para carregar categorias para o dropdown de orçamento
      function loadCategoriesForBudget() {
        console.log("loadCategoriesForBudget: Iniciando carregamento de categorias para orçamento.");
        google.script.run.withSuccessHandler(function(data) {
          console.log("loadCategoriesForBudget: Dados de categorias recebidos:", data);
          if (data.categorias && data.categorias.length > 0 && data.categorias[0] && Array.isArray(data.categorias[0])) {
            allCategoriesData = data.categorias; // Armazena todas as categorias globalmente
            filterCategoriesForBudgetByType($('#budgetType').val()); // Filtra na inicialização
            console.log("loadCategoriesForBudget: Categorias carregadas e filtradas inicialmente.");
          } else {
            console.warn("loadCategoriesForBudget: Nenhuma categoria ou dados de categoria inválidos recebidos.");
            $('#budgetCategory').empty().append('<option value="">Nenhuma categoria encontrada.</option>');
          }
        }).withFailureHandler(function(error) {
            console.error("loadCategoriesForBudget: Erro ao carregar categorias do backend:", error.message);
            $('#budgetCategory').empty().append('<option value="">Erro ao carregar dados.</option>');
        }).getSheetDataBatch({
          categorias: 'Categorias'
        });
      }

      // Nova função para filtrar e popular o dropdown de categorias no formulário de orçamento
      function filterCategoriesForBudgetByType(budgetType) {
        console.log(`filterCategoriesForBudgetByType: Filtering categories for budget type: ${budgetType}`);
        const categoriaDropdown = $('#budgetCategory');
        categoriaDropdown.empty().append('<option value="">Selecione...</option>');

        if (!allCategoriesData || allCategoriesData.length === 0 || !allCategoriesData[0] || !Array.isArray(allCategoriesData[0])) {
            console.warn("filterCategoriesForBudgetByType: allCategoriesData inválida ou vazia.", allCategoriesData);
            return;
        }

        const categoriaHeaders = allCategoriesData[0];
        const categoriaNomeCol = categoriaHeaders.indexOf('Nome da Categoria');
        const categoriaTipoCol = categoriaHeaders.indexOf('Tipo');

        if (categoriaNomeCol === -1 || categoriaTipoCol === -1) {
          console.error(`filterCategoriesForBudgetByType: Cabeçalhos "Nome da Categoria" ou "Tipo" não encontrados na aba Categorias. Headers:`, categoriaHeaders);
          return;
        }

        const filteredCategories = allCategoriesData.slice(1).filter(row => {
            if (!budgetType) return false;
            let sheetType = row[categoriaTipoCol];
            // 'Entrada' no sheet mapeia para 'Receita' no orçamento
            // Adicionado .trim() para remover espaços extras e garantir comparação exata
            const mappedType = budgetType === 'Receita' ? 'Entrada' : budgetType; 
            return (sheetType && typeof sheetType === 'string' && sheetType.trim() === mappedType.trim());
        });

        filteredCategories.forEach(row => {
          const categoriaNome = row[categoriaNomeCol];
          if (categoriaNome) { // Garante que o nome da categoria não é vazio
            categoriaDropdown.append(`<option value="${categoriaNome}">${categoriaNome}</option>`);
          }
        });
        console.log(`filterCategoriesForBudgetByType: Categorias filtradas e populadas. Total: ${filteredCategories.length} para tipo ${budgetType}.`);
      }

      // Event listener para mudança no tipo de orçamento (Receita/Despesa)
      $('#budgetType').on('change', function() {
        filterCategoriesForBudgetByType($(this).val());
      });


      // Envio de Orçamento
      $('#budgetForm').on('submit', function(event) {
        event.preventDefault();
        const form = $(this)[0];

        const budgetValueParsed = unmaskAndParseCurrency($('#budgetValue').val());
        $('#budgetValue').val(budgetValueParsed); // Define o valor numérico puro para validação temporariamente

        if (!form.checkValidity()) {
          event.stopPropagation();
          if (!isNaN(budgetValueParsed)) { 
              $('#budgetValue').val(formatCurrency(budgetValueParsed)); 
          }
        } else {
          const budgetData = {
            anoMes: $('#budgetAnoMes').val(),
            categoria: $('#budgetCategory').val(),
            produtoServico: $('#budgetProductService').val(),
            tipo: $('#budgetType').val(), // Mapeia diretamente Receita/Despesa
            valorOrcado: parseFloat(budgetValueParsed) // Envia o valor numérico puro
          };
          console.log("saveBudget: Enviando dados:", budgetData);
          google.script.run
            .withSuccessHandler(function(success) {
              if (success) {
                $('#budgetMessage').html('<div class="alert alert-success">Orçamento salvo/atualizado com sucesso!</div>');
                form.reset();
                form.classList.remove('was-validated');
                $('#budgetValue').mask('0.000.000.000.000,00', {reverse: true}); // Re-aplica a máscara após o reset
                if ($('#analysisAnoMes').val() && $('#analysisAnoMes').val() === budgetData.anoMes) {
                    $('#loadBudgetAnalysis').click();
                }
                filterCategoriesForBudgetByType(''); // Limpa dropdown
              } else {
                $('#budgetMessage').html('<div class="alert alert-danger">Erro ao salvar orçamento. Verifique os logs.</div>');
                console.error("saveBudget: Erro ao salvar orçamento (backend retornou false).");
              }
            })
            .withFailureHandler(function(error) {
                $('#budgetMessage').html('<div class="alert alert-danger">Ocorreu um erro inesperado: ' + error.message + '</div>');
                console.error("saveBudget: Erro inesperado do backend:", error);
            })
            .saveBudget(budgetData);
        }
        form.classList.add('was-validated');
      });

      // Carregar Análise de Orçamento
      $('#loadBudgetAnalysis').on('click', function() {
        const anoMes = $('#analysisAnoMes').val();
        if (!anoMes) {
          alert('Por favor, selecione um mês e ano para a análise do orçamento.');
          return;
        }
        console.log("getBudgetAnalysis: Solicitando análise para AnoMes:", anoMes);
        google.script.run
          .withSuccessHandler(function(data) {
            console.log("getBudgetAnalysis: Dados de análise recebidos:", data);
            let htmlReceitas = '';
            if (!data || !data.receitas || data.receitas.length === 0) {
              htmlReceitas = '<tr><td colspan="5" class="text-center text-muted">Nenhum dado de receita para o mês selecionado.</td></tr>';
            } else {
              data.receitas.forEach(item => {
                const diferenca = item.realizado - item.estimado;
                let statusText = 'OK';
                let statusClass = 'text-success';
                if (diferenca < 0) {
                    statusText = 'Abaixo do Estimado';
                    statusClass = 'text-danger';
                } else if (diferenca > 0) {
                    statusText = 'Acima do Estimado';
                    statusClass = 'text-info';
                }

                htmlReceitas += `<tr>
                  <td>${item.categoria}</td>
                  <td>${formatCurrency(item.estimado)}</td>
                  <td>${formatCurrency(item.realizado)}</td>
                  <td class="${diferenca >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(diferenca)}</td>
                  <td class="${statusClass}">${statusText}</td>
                </tr>`;
              });
            }
            $('#budgetAnalysisTableReceitas').html(htmlReceitas);


            let htmlDespesas = '';
            if (!data || !data.despesas || data.despesas.length === 0) {
              htmlDespesas = '<tr><td colspan="5" class="text-center text-muted">Nenhum dado de despesa para o mês selecionado.</td></tr>';
            } else {
              data.despesas.forEach(item => {
                const diferenca = item.orcado - item.gasto;
                let statusText = 'OK';
                let statusClass = 'text-success';
                if (diferenca < 0) {
                    statusText = 'Estourou o Orçamento';
                    statusClass = 'text-danger';
                } else if (diferenca > 0) {
                    statusText = 'Sobrando';
                    statusClass = 'text-info';
                }

                htmlDespesas += `<tr>
                  <td>${item.categoria}</td>
                  <td>${formatCurrency(item.orcado)}</td>
                  <td>${formatCurrency(item.gasto)}</td>
                  <td class="${diferenca >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(diferenca)}</td>
                  <td class="${statusClass}">${statusText}</td>
                </tr>`;
              });
            }
            $('#budgetAnalysisTableDespesas').html(htmlDespesas);
            console.log("getBudgetAnalysis: Análise de orçamento populada.");

          })
          .withFailureHandler(function(error) {
              $('#budgetAnalysisTableReceitas').html('<tr><td colspan="5" class="text-center text-danger">Erro ao carregar análise de receitas: ' + error.message + '</td></tr>');
              $('#budgetAnalysisTableDespesas').html('<tr><td colspan="5" class="text-center text-danger">Erro ao carregar análise de despesas: ' + error.message + '</td></tr>');
              console.error("getBudgetAnalysis: Erro na análise de orçamento:", error);
          })
          .getBudgetAnalysis(anoMes);
      });

      // Inicialização
      loadCategoriesForBudget();

      // Ativa a validação do Bootstrap
      const forms = document.querySelectorAll('.needs-validation');
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    });
  </script>
</body>
</html>