<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Análises e Sugestões - Controle Financeiro Familiar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    body { 
      padding-top: 20px; 
      background-color: #f0f2f5; /* Fundo suave */
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
    }
    .container { 
      max-width: 1000px; 
      background-color: #ffffff; 
      padding: 30px; 
      border-radius: 12px; /* Cantos arredondados */
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); /* Sombra suave */
      margin-bottom: 50px; 
    }
    h1, h2, h3 { 
      color: #343a40; 
      margin-bottom: 25px; /* Espaçamento padrão */
      font-weight: 600;
    }
    .btn-back {
      margin-bottom: 20px;
      background-color: #6c757d; /* Cinza do Bootstrap */
      border-color: #6c757d;
      transition: all 0.3s ease;
    }
    .btn-back:hover {
      background-color: #5a6268;
      border-color: #545b62;
      transform: translateY(-1px);
    }
    .form-label {
      font-weight: 500;
      color: #495057;
    }
    .form-control, .form-select {
      border-radius: 8px;
      border: 1px solid #ced4da;
      padding: 0.75rem 1rem;
    }
    .form-control:focus, .form-select:focus {
      border-color: #80bdff;
      box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
    }
    .btn-primary, .btn-info {
      border-radius: 8px;
      padding: 0.75rem 1.25rem;
      transition: all 0.3s ease;
    }
    .btn-primary {
      background-color: #007bff;
      border-color: #007bff;
    }
    .btn-primary:hover {
      background-color: #0056b3;
      border-color: #0056b3;
      transform: translateY(-1px);
    }
    .btn-info {
        background-color: #17a2b8;
        border-color: #17a2b8;
        color: #fff;
    }
    .btn-info:hover {
        background-color: #117a8b;
        border-color: #10707f;
        transform: translateY(-1px);
    }
    .table thead th {
      background-color: #e9ecef;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
      padding: 1rem;
    }
    .table tbody tr:hover {
      background-color: #f2f2f2;
    }
    .table td {
      vertical-align: middle;
      padding: 0.75rem;
    }
    .alert-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; border-radius: 8px; }
    .alert-danger { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; border-radius: 8px; }
    .status-positive { color: #28a745; font-weight: bold; } /* Bootstrap green */
    .status-negative { color: #dc3545; font-weight: bold; } /* Bootstrap red */

    .analysis-card { 
      margin-top: 30px; 
      border: 1px solid #e0e0e0; 
      border-radius: 12px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
      overflow: hidden; /* Garante que o border-radius funcione com o header */
    }
    .analysis-card .card-header { 
      background-color: #f8f9fa; /* Um cinza mais claro */
      color: #343a40;
      font-weight: bold; 
      padding: 1.2rem 1.5rem; /* Mais padding */
      border-bottom: 1px solid #e9ecef;
      font-size: 1.1em;
    }
    .analysis-card .card-body { 
      padding: 25px; 
    }
    .list-group-item.suggestion {
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.03);
    }

    /* Media queries para responsividade */
    @media (max-width: 768px) {
      .container {
        padding: 20px;
        border-radius: 8px;
      }
      h1, h2, h3 {
        font-size: 1.5em;
        margin-bottom: 20px;
      }
      .form-control, .form-select {
        padding: 0.6rem 0.8rem;
        font-size: 0.9rem;
      }
      .btn-primary, .btn-info {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
      }
      .table th, .table td {
        padding: 0.6rem;
        font-size: 0.85rem;
      }
      .analysis-card .card-header {
        font-size: 1em;
        padding: 1rem;
      }
      .analysis-card .card-body {
        padding: 15px;
      }
      .col-md-6 {
        width: 100%; /* Empilha em telas pequenas */
      }
    }
    @media (max-width: 576px) {
      .col-md-3, .col-md-6 {
        width: 100%;
        margin-top: 15px; /* Espaçamento entre colunas empilhadas */
      }
      .btn {
        width: 100%; /* Botões ocupam a largura total */
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec" class="btn btn-secondary btn-back">← Voltar ao Menu Principal</a>
    
    <h1 class="mb-4">Análises e Sugestões Financeiras</h1>
    <p class="lead text-muted">Aqui você encontrará análises e insights sobre seus hábitos financeiros para ajudar na tomada de decisões e no planejamento.</p>

    <div class="card analysis-card">
      <div class="card-header">Gastos Médios Mensais por Categoria (Análise Preditiva Simples)</div>
      <div class="card-body">
        <p class="text-muted">Baseado em seu histórico de transações de saída, esta tabela mostra uma estimativa do quanto você gasta, em média, por categoria mensalmente. Ajuda a identificar padrões e planejar o futuro.</p>
        <button class="btn btn-info mb-3 w-100 w-md-auto" id="loadAverageSpendingsBtn">Recarregar Análise</button>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Categoria</th>
                <th>Gasto Médio Mensal (R$)</th>
              </tr>
            </thead>
            <tbody id="averageSpendingsTable">
              <tr><td colspan="2" class="text-center">Clique em "Recarregar Análise" para carregar os dados.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card analysis-card">
      <div class="card-header">Fluxo de Caixa Anual/Mensal</div>
      <div class="card-body">
        <div class="row mb-3 g-3">
          <div class="col-md-6">
            <label for="flowYear" class="form-label">Ano</label>
            <input type="number" class="form-control" id="flowYear" value="<?= new Date().getFullYear() ?>">
          </div>
          <div class="col-md-6">
            <label for="flowType" class="form-label">Tipo de Visualização</label>
            <select class="form-select" id="flowType">
              <option value="monthly">Mensal</option>
              <option value="annual">Anual</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary mb-3 w-100 w-md-auto" id="loadFlowAnalysis">Carregar Fluxo de Caixa</button>
        <div class="table-responsive mb-4">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Período</th>
                <th>Receitas</th>
                <th>Despesas</th>
                <th>Saldo</th>
              </tr>
            </thead>
            <tbody id="flowAnalysisTable">
              <tr><td colspan="4" class="text-center text-muted">Selecione um ano e tipo para carregar o fluxo de caixa.</td></tr>
            </tbody>
          </table>
        </div>
        <canvas id="flowChart" style="max-height: 400px; display: none;"></canvas>
      </div>
    </div>

    <div class="card analysis-card">
      <div class="card-header">Sugestões de Economia</div>
      <div class="card-body">
        <p class="text-muted">Identifica categorias onde seus gastos são significativamente altos e sugere áreas para possível economia.</p>
        <button class="btn btn-primary mb-3 w-100 w-md-auto" id="loadSavingsSuggestions">Gerar Sugestões</button>
        <div id="savingsSuggestionsContent">
          <p class="text-center text-muted">Clique em "Gerar Sugestões" para analisar seus gastos.</p>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
  <script>
    $(document).ready(function() {
      // ATENÇÃO: Este é o URL base da sua Web App do Google Apps Script.
      // Se você fizer uma nova implantação ou o URL mudar por qualquer motivo,
      // VOCÊ DEVE ATUALIZAR ESTE URL EM TODOS OS ARQUIVOS HTML DO SEU PROJETO.
      // URL ATUAL: https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec
      const mainAppUrl = "https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec"; 
      $('.btn-back').attr('href', mainAppUrl);

      // Função auxiliar para formatar valor como moeda BRL
      function formatCurrency(value) {
          if (typeof value !== 'number') {
              value = parseFloat(value);
          }
          if (isNaN(value)) {
              return 'R$ 0,00';
          }
          return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      }

      // Função auxiliar para limpar a formatação e obter o número (para campos de input, se houvesse)
      function unmaskAndParseCurrency(value) {
          // Esta função é mais relevante para inputs mascarados, mas mantida por consistência
          if (typeof value === 'string') {
              return parseFloat(value.replace(/[R$ ]/g, '').replace(/\./g, '').replace(/,/g, '.'));
          }
          return value;
      }

      // Carregar Gastos Médios Mensais (Análise Preditiva Simples)
      $('#loadAverageSpendingsBtn').on('click', function() {
        console.log("loadAverageSpendingsBtn: Iniciando carregamento de gastos médios.");
        google.script.run
          .withSuccessHandler(function(data) {
            console.log("loadAverageSpendingsBtn: Dados de gastos médios recebidos:", data);
            let html = '';
            if (Object.keys(data).length === 0) {
              html = '<tr><td colspan="2" class="text-center text-muted">Nenhum dado de gasto para análise.</td></tr>';
            } else {
              const sortedCategories = Object.keys(data).sort(); // Ordena as categorias por nome
              sortedCategories.forEach(category => {
                html += `<tr>
                  <td>${category}</td>
                  <td>${formatCurrency(data[category])}</td>
                </tr>`;
              });
            }
            $('#averageSpendingsTable').html(html);
            console.log("loadAverageSpendingsBtn: Tabela de gastos médios populada.");
          })
          .withFailureHandler(function(error) {
              $('#averageSpendingsTable').html('<tr><td colspan="2" class="text-center text-danger">Erro ao carregar análise: ' + error.message + '</td></tr>');
              console.error("loadAverageSpendingsBtn: Erro na análise de gastos médios:", error);
          })
          .getAverageMonthlySpendings();
      });

      // --- Funções para Análise de Fluxo de Caixa ---

      let flowChartInstance; // Para armazenar a instância do Chart.js

      $('#loadFlowAnalysis').on('click', function() {
        const year = $('#flowYear').val();
        const type = $('#flowType').val();

        if (!year) {
          alert('Por favor, insira o ano para a análise de fluxo de caixa.');
          console.warn("loadFlowAnalysis: Ano não selecionado.");
          return;
        }
        console.log(`loadFlowAnalysis: Solicitando fluxo de caixa para Ano: ${year}, Tipo: ${type}`);
        google.script.run
          .withSuccessHandler(function(data) {
            console.log("loadFlowAnalysis: Dados de fluxo de caixa recebidos:", data);
            let html = '';
            let labels = [];
            let revenues = [];
            let expenses = [];
            let balances = [];

            if (!data || data.length === 0) {
              html = '<tr><td colspan="4" class="text-center text-muted">Nenhum dado de transação para o período e ano selecionados.</td></tr>';
            } else {
              data.forEach(item => {
                html += `<tr>
                  <td>${item.period}</td>
                  <td class="text-success">${formatCurrency(item.revenues)}</td>
                  <td class="text-danger">${formatCurrency(item.expenses)}</td>
                  <td class="${item.balance >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(item.balance)}</td>
                </tr>`;
                labels.push(item.period);
                revenues.push(item.revenues);
                expenses.push(item.expenses);
                balances.push(item.balance);
              });
            }
            $('#flowAnalysisTable').html(html);
            console.log("loadFlowAnalysis: Tabela de fluxo de caixa populada.");

            // Renderizar gráfico se houver dados
            const ctx = document.getElementById('flowChart').getContext('2d');
            $('#flowChart').show(); // Mostra o canvas do gráfico

            if (flowChartInstance) {
              flowChartInstance.destroy(); // Destrói a instância anterior se existir
            }

            flowChartInstance = new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Receitas',
                  data: revenues,
                  borderColor: 'rgb(40, 167, 69)', // Bootstrap green
                  backgroundColor: 'rgba(40, 167, 69, 0.2)',
                  tension: 0.1,
                  fill: false
                }, {
                  label: 'Despesas',
                  data: expenses,
                  borderColor: 'rgb(220, 53, 69)', // Bootstrap red
                  backgroundColor: 'rgba(220, 53, 69, 0.2)',
                  tension: 0.1,
                  fill: false
                }, {
                  label: 'Saldo',
                  data: balances,
                  borderColor: 'rgb(0, 123, 255)', // Bootstrap blue
                  backgroundColor: 'rgba(0, 123, 255, 0.2)',
                  tension: 0.1,
                  fill: true // Preenche a área do saldo
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  title: {
                    display: true,
                    text: `Fluxo de Caixa ${type === 'monthly' ? 'Mensal' : 'Anual'} (${year})`
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: 'Valor (R$)'
                    },
                    // Adapta o formatador do eixo Y para moeda
                    ticks: {
                        callback: function(value, index, values) {
                            return formatCurrency(value);
                        }
                    }
                  },
                  x: {
                    title: {
                      display: true,
                      text: 'Período'
                    }
                  }
                }
              }
            });
            console.log("loadFlowAnalysis: Gráfico de fluxo de caixa renderizado.");

          })
          .withFailureHandler(function(error) {
              $('#flowAnalysisTable').html('<tr><td colspan="4" class="text-center text-danger">Erro ao carregar fluxo de caixa: ' + error.message + '</td></tr>');
              console.error("loadFlowAnalysis: Erro no fluxo de caixa:", error);
              $('#flowChart').hide(); // Esconde o gráfico em caso de erro
          })
          .getFinancialFlowAnalysis(year, type); 
      });

      // --- Funções para Sugestões de Economia ---

      $('#loadSavingsSuggestions').on('click', function() {
        console.log("loadSavingsSuggestions: Solicitando sugestões de economia.");
        google.script.run
          .withSuccessHandler(function(data) {
            console.log("loadSavingsSuggestions: Dados de sugestões recebidos:", data);
            let html = '';
            if (!data || data.length === 0 || (data.length === 1 && data[0].category === 'N/A')) { // Alterado de 'categoria' para 'category' para consistência
              html = '<p class="text-center text-muted">Não há dados suficientes para gerar sugestões de economia.</p>';
            } else {
              html += '<p class="fw-bold">Com base em seus gastos médios por categoria, aqui estão algumas sugestões:</p>';
              html += '<ul class="list-group">';
              data.forEach(item => {
                html += `<li class="list-group-item list-group-item-action suggestion d-flex flex-column align-items-start">
                            <div class="w-100 d-flex justify-content-between align-items-center mb-1">
                                <strong>${item.category}</strong>: Gasto médio mensal de ${formatCurrency(item.averageSpend)}. 
                                <span class="badge bg-warning text-dark">Potencial de economia!</span>
                            </div>
                            <small class="text-muted">${item.suggestion}</small>
                         </li>`;
              });
              html += '</ul>';
            }
            $('#savingsSuggestionsContent').html(html);
            console.log("loadSavingsSuggestions: Sugestões de economia populadas.");
          })
          .withFailureHandler(function(error) {
              $('#savingsSuggestionsContent').html('<div class="alert alert-danger">Erro ao gerar sugestões: ' + error.message + '</div>');
              console.error("loadSavingsSuggestions: Erro nas sugestões de economia:", error);
          })
          .getSpendingSuggestions(); 
      });
      
    });
  </script>
</body>
</html>