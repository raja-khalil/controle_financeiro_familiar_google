<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Dashboard - Controle Financeiro Familiar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding-top: 20px; background-color: #f8f9fa; font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
    .container { max-width: 1000px; background-color: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.1); margin-bottom: 50px; }
    h1, h2, h3 { color: #343a40; }
    .btn-back { margin-bottom: 20px; }
    .card-header { font-weight: bold; }
    .alert-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
    .alert-danger { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
    .alert-info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
    iframe { border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
    .list-group-item { display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body>
  <div class="container">
    <a href="https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec" class="btn btn-secondary btn-back">← Voltar ao Menu Principal</a>
    
    <h1 class="mb-4">Dashboard Financeiro</h1>

    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card mb-3">
          <div class="card-header bg-primary text-white">Saldo Consolidado das Contas</div>
          <div class="card-body" id="saldoContas">
            <p>Carregando saldos...</p>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card mb-3">
          <div class="card-header bg-warning text-dark">Próximas Contas a Pagar / Dívidas Vencendo</div>
          <div class="card-body" id="proximasContas">
            <p>Carregando...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-4 text-center">
        <h4>Dashboard Visual (Google Looker Studio)</h4>
        <p>Seu dashboard interativo pode ser incorporado aqui para uma visualização rica dos dados.</p>
        <div class="alert alert-info">
            **Lembre-se:** Você precisará criar e publicar seu dashboard no <a href="https://lookerstudio.google.com/" target="_blank">Google Looker Studio</a> e substituir o `src` do iframe abaixo com o link de incorporação real do seu relatório.
            <br>
            Ex: `https://lookerstudio.google.com/embed/reporting/SEU_ID_DO_RELATORIO/page/SEU_ID_DA_PAGINA`
        </div>
        <iframe src="https://lookerstudio.google.com/embed/reporting/SUA_ID_DO_RELATORIO_LOOKER_STUDIO/page/p_SUA_PAGINA" width="100%" height="600" frameborder="0" style="border:0" allowfullscreen sandbox="allow-scripts allow-same-origin allow-popups"></iframe>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

  <script>
    $(document).ready(function() {
      // URL da Web App já inserido aqui
      const mainAppUrl = "https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec"; 
      $('.btn-back').attr('href', mainAppUrl);

      // Carregar Saldo Total das Contas para o Dashboard
      function loadAccountBalances() {
        google.script.run.withSuccessHandler(function(data) {
          let totalBalance = 0;
          let html = '<ul class="list-group">';
          
          if (data.length <= 1) {
            html = '<p class="text-muted">Nenhuma conta configurada ainda na sua planilha.</p>';
          } else {
            const headers = data[0];
            const accountNameCol = headers.indexOf('Nome da Conta');
            const saldoAtualCol = headers.indexOf('Saldo Atual');
            const bancoCol = headers.indexOf('Banco');

            if (accountNameCol === -1 || saldoAtualCol === -1 || bancoCol === -1) {
                console.error("Cabeçalhos da aba 'Contas' inválidos. Verifique 'Nome da Conta', 'Saldo Atual', 'Banco'.");
                $('#saldoContas').html('<div class="alert alert-danger">Erro ao carregar saldos. Verifique a estrutura da aba "Contas".</div>');
                return;
            }

            data.slice(1).forEach(row => {
              const accountName = row[accountNameCol];
              const banco = row[bancoCol];
              const currentBalance = parseFloat(row[saldoAtualCol] || 0);
              totalBalance += currentBalance;
              html += `<li class="list-group-item">
                         <span>${accountName} <span class="text-muted">(${banco})</span></span>
                         <span class="badge bg-${currentBalance >= 0 ? 'success' : 'danger'} rounded-pill">R$ ${currentBalance.toFixed(2)}</span>
                       </li>`;
            });
            html += '</ul>';
          }
          html += `<h5 class="mt-3">Saldo Consolidado Total: <span class="text-${totalBalance >= 0 ? 'success' : 'danger'}">R$ ${totalBalance.toFixed(2)}</span></h5>`;
          $('#saldoContas').html(html);
        }).getSheetData('Contas');
      }

      // Carregar Próximas Contas a Pagar / Dívidas Vencendo
      function loadUpcomingBills() {
        google.script.run.withSuccessHandler(function(data) {
          let html = '<ul class="list-group">';
          if (data.length <= 1) {
            html += '<li class="list-group-item text-muted">Nenhuma dívida registrada ou próxima do vencimento.</li>';
          } else {
            const headers = data[0];
            const nomeDividaCol = headers.indexOf('Nome da Dívida');
            const dataVencimentoCol = headers.indexOf('Data Vencimento');
            const statusCol = headers.indexOf('Status');

            if ([nomeDividaCol, dataVencimentoCol, statusCol].some(idx => idx === -1)) {
                console.error("Cabeçalhos da aba 'Dividas' inválidos. Verifique a estrutura.");
                $('#proximasContas').html('<div class="alert alert-danger">Erro ao carregar dívidas. Verifique a estrutura da aba "Dividas".</div>');
                return;
            }

            const today = new Date();
            today.setHours(0,0,0,0);

            const upcomingBills = [];
            data.slice(1).forEach(row => {
              const nomeDivida = row[nomeDividaCol];
              const dataVencimento = new Date(row[dataVencimentoCol]);
              const status = row[statusCol];

              if (status === 'Ativa' || status === 'Aguardando Início') {
                  const diffTime = dataVencimento.getTime() - today.getTime();
                  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                  if (diffDays >= 0 && diffDays <= 30) {
                      upcomingBills.push({ name: nomeDivida, date: dataVencimento.toLocaleDateString('pt-BR'), daysLeft: diffDays, statusType: 'Próximo' });
                  } else if (diffDays < 0) {
                      upcomingBills.push({ name: nomeDivida, date: dataVencimento.toLocaleDateString('pt-BR'), daysLeft: Math.abs(diffDays), statusType: 'Atrasado' });
                  }
              }
            });

            if (upcomingBills.length > 0) {
                upcomingBills.sort((a,b) => {
                    if (a.statusType === 'Atrasado' && b.statusType !== 'Atrasado') return -1;
                    if (a.statusType !== 'Atrasado' && b.statusType === 'Atrasado') return 1;
                    return a.daysLeft - b.daysLeft;
                });

                upcomingBills.forEach(bill => {
                    const statusClass = bill.statusType === 'Atrasado' ? 'bg-danger' : 'bg-info';
                    const statusText = bill.statusType === 'Atrasado' ? `Atrasado (${bill.daysLeft} dias)` : `Vence em ${bill.daysLeft} dias`;
                    html += `<li class="list-group-item">
                                <span>${bill.name} - ${bill.date}</span>
                                <span class="badge ${statusClass} rounded-pill">${statusText}</span>
                             </li>`;
                });
            } else {
                html += '<li class="list-group-item text-muted">Nenhuma dívida próxima ou atrasada.</li>';
            }
          }
          html += '</ul>';
          $('#proximasContas').html(html);
        }).getSheetData('Dividas');
      }

      // Inicialização
      loadAccountBalances();
      loadUpcomingBills();
    });
  </script>
</body>
</html>