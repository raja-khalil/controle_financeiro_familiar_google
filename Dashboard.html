<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Dashboard - Controle Financeiro Familiar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    body { 
      padding-top: 20px; 
      background-color: #f0f2f5; /* Fundo suave */
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
    }
    .container { 
      max-width: 1000px; 
      background-color: #ffffff; 
      padding: 30px; 
      border-radius: 12px; /* Cantos arredondados */
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); /* Sombra suave */
      margin-bottom: 50px; 
    }
    h1, h2, h3 { 
      color: #343a40; 
      margin-bottom: 25px; /* Espaçamento padrão */
      font-weight: 600;
    }
    .btn-back {
      margin-bottom: 20px;
      background-color: #6c757d; /* Cinza do Bootstrap */
      border-color: #6c757d;
      transition: all 0.3s ease;
    }
    .btn-back:hover {
      background-color: #5a6268;
      border-color: #545b62;
      transform: translateY(-1px);
    }
    .card {
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border: none; /* Remove a borda padrão do card */
    }
    .card-header { 
        font-weight: bold; 
        padding: 1.25rem 1.5rem; /* Mais padding */
        border-bottom: 1px solid rgba(0,0,0,.125); /* Borda mais discreta */
        border-top-left-radius: 12px; /* Mantém cantos arredondados */
        border-top-right-radius: 12px;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .card-body {
        padding: 1.5rem; /* Mais padding */
    }
    .alert {
        border-radius: 8px;
        font-size: 0.95rem;
    }
    .alert-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
    .alert-danger { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
    .alert-info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
    iframe { 
      border-radius: 12px; 
      box-shadow: 0 5px 20px rgba(0,0,0,0.15); /* Sombra mais pronunciada para o iframe */
      border: 1px solid #e0e0e0; /* Uma borda sutil */
    }
    .list-group-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 0.75rem 1.25rem;
      border: 1px solid rgba(0,0,0,.125); /* Borda padrão do list-group */
      border-radius: 8px; /* Cantos arredondados para itens da lista */
      margin-bottom: 5px; /* Espaçamento entre itens */
    }
    .list-group-item:last-child {
        margin-bottom: 0;
    }
    .list-group-item span.badge {
        min-width: 80px; /* Garante largura mínima para o badge */
        text-align: center;
        padding: 0.5em 0.75em;
        font-size: 0.85em;
        border-radius: 0.5rem;
    }
    .text-success { color: #28a745 !important; font-weight: 600; }
    .text-danger { color: #dc3545 !important; font-weight: 600; }
    .text-warning-custom { color: #ffc107 !important; } /* Cor para o cabeçalho de dívidas */

    /* Classes para as cores dos cabeçalhos dos cards */
    .bg-primary-darker { background-color: #0056b3 !important; } /* Azul mais escuro */
    .bg-warning-darker { background-color: #e0a800 !important; } /* Amarelo mais escuro */

    /* Media queries para responsividade */
    @media (max-width: 992px) { /* Tablets e menores */
        .container { max-width: 90%; padding: 25px; }
        .card-header { font-size: 1em; padding: 1rem 1.25rem; }
        .card-body { padding: 1.25rem; }
        h1 { font-size: 2em; }
    }
    @media (max-width: 768px) { /* Celulares maiores */
      .container {
        padding: 20px;
        border-radius: 8px;
      }
      .col-md-6 {
        width: 100%; /* Cartões empilham em telas menores */
      }
      .row > .col-md-6:first-child {
        margin-bottom: 20px; /* Espaçamento entre os cartões empilhados */
      }
      h1, h2, h3 {
        font-size: 1.5em;
        margin-bottom: 20px;
      }
      .btn-back {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
      }
      .list-group-item {
          padding: 0.6rem 1rem;
          font-size: 0.9em;
      }
      .list-group-item span.badge {
          min-width: 60px;
          font-size: 0.75em;
      }
      iframe { height: 400px; } /* Altura ajustada para telas menores */
    }
    @media (max-width: 576px) { /* Celulares muito pequenos */
      .card-header {
        flex-direction: column; /* Empilha título e ícone/botão no header */
        align-items: flex-start;
      }
      .list-group-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .list-group-item span {
        margin-bottom: 5px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec" class="btn btn-secondary btn-back">← Voltar ao Menu Principal</a>
    
    <h1 class="mb-4">Dashboard Financeiro</h1>

    <div class="row mt-4 g-4"> <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-primary-darker text-white">Saldo Consolidado das Contas</div>
          <div class="card-body" id="saldoContas">
            <p class="text-muted">Carregando saldos...</p>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-warning-darker text-dark">Próximas Contas a Pagar / Dívidas Vencendo</div>
          <div class="card-body" id="proximasContas">
            <p class="text-muted">Carregando...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-5 text-center">
        <h4>Dashboard Visual (Google Looker Studio)</h4>
        <p class="text-muted">Seu dashboard interativo pode ser incorporado aqui para uma visualização rica dos dados.</p>
        <div class="alert alert-info">
            **Lembre-se:** Você precisará criar e publicar seu dashboard no <a href="https://lookerstudio.google.com/" target="_blank" class="alert-link">Google Looker Studio</a> e substituir o `src` do iframe abaixo com o link de incorporação real do seu relatório.
            <br>
            Ex: `https://lookerstudio.google.com/embed/reporting/SEU_ID_DO_RELATORIO/page/SEU_ID_DA_PAGINA`
        </div>
        <iframe src="https://lookerstudio.google.com/embed/reporting/SUA_ID_DO_RELATORIO_LOOKER_STUDIO/page/p_SUA_PAGINA" width="100%" height="600" frameborder="0" style="border:0" allowfullscreen sandbox="allow-scripts allow-same-origin allow-popups"></iframe>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script>
    $(document).ready(function() {
      // ATENÇÃO: Este é o URL base da sua Web App do Google Apps Script.
      // Se você fizer uma nova implantação ou o URL mudar por qualquer motivo,
      // VOCÊ DEVE ATUALIZAR ESTE URL EM TODOS OS ARQUIVOS HTML DO SEU PROJETO.
      // URL ATUAL: https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec
      const mainAppUrl = "https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec"; 
      $('.btn-back').attr('href', mainAppUrl);

      // Função auxiliar para formatar valor como moeda BRL
      function formatCurrency(value) {
          if (typeof value !== 'number') {
              value = parseFloat(value);
          }
          if (isNaN(value)) {
              return 'R$ 0,00';
          }
          return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      }

      // Carregar Saldo Total das Contas para o Dashboard
      function loadAccountBalances() {
        console.log("loadAccountBalances: Iniciando carregamento de saldos de contas.");
        google.script.run.withSuccessHandler(function(data) {
          console.log("loadAccountBalances: Dados de saldos recebidos:", data);
          let totalBalance = 0;
          let html = '<ul class="list-group list-group-flush">'; 
          
          if (!data || data.length <= 1 || !data[0] || !Array.isArray(data[0])) {
            html = '<p class="text-muted">Nenhuma conta configurada ou dados inválidos na sua planilha.</p>';
            console.warn("loadAccountBalances: Nenhuma conta ou dados de conta inválidos recebidos.");
          } else {
            const headers = data[0];
            const accountNameCol = headers.indexOf('Nome da Conta');
            const saldoAtualCol = headers.indexOf('Saldo Atual');
            const bancoCol = headers.indexOf('Banco');

            if (accountNameCol === -1 || saldoAtualCol === -1 || bancoCol === -1) {
                console.error("loadAccountBalances: Cabeçalhos da aba 'Contas' inválidos. Verifique 'Nome da Conta', 'Saldo Atual', 'Banco'. Headers:", headers);
                $('#saldoContas').html('<div class="alert alert-danger">Erro ao carregar saldos. Verifique a estrutura da aba "Contas".</div>');
                return;
            }

            data.slice(1).forEach(row => {
              const accountName = row[accountNameCol];
              const banco = row[bancoCol];
              const currentBalance = parseFloat(row[saldoAtualCol] || 0);
              totalBalance += currentBalance;
              html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                          <span>${accountName} <span class="text-muted">(${banco || 'N/A'})</span></span>
                          <span class="badge bg-${currentBalance >= 0 ? 'success' : 'danger'}">${formatCurrency(currentBalance)}</span>
                        </li>`;
            });
            html += '</ul>';
            console.log("loadAccountBalances: Saldos de contas populados.");
          }
          html += `<h5 class="mt-3">Saldo Consolidado Total: <span class="text-${totalBalance >= 0 ? 'success' : 'danger'}">${formatCurrency(totalBalance)}</span></h5>`;
          $('#saldoContas').html(html);
        }).withFailureHandler(function(error) {
            console.error("loadAccountBalances: Erro ao carregar saldos do backend:", error.message);
            $('#saldoContas').html('<div class="alert alert-danger">Erro inesperado ao carregar saldos: ' + error.message + '</div>');
        }).getSheetData('Contas');
      }

      // Carregar Próximas Contas a Pagar / Dívidas Vencendo
      function loadUpcomingBills() {
        console.log("loadUpcomingBills: Iniciando carregamento de próximas contas/dívidas.");
        google.script.run.withSuccessHandler(function(data) {
          console.log("loadUpcomingBills: Dados de dívidas recebidos:", data);
          let html = '<ul class="list-group list-group-flush">';
          if (!data || data.length <= 1 || !data[0] || !Array.isArray(data[0])) {
            html += '<li class="list-group-item text-muted">Nenhuma dívida registrada ou próxima do vencimento.</li>';
            console.warn("loadUpcomingBills: Nenhuma dívida ou dados de dívida inválidos recebidos.");
          } else {
            const headers = data[0];
            const nomeDividaCol = headers.indexOf('Nome da Dívida');
            const dataVencimentoCol = headers.indexOf('Data Vencimento');
            const statusCol = headers.indexOf('Status');
            const valorTotalCol = headers.indexOf('Valor Total'); 
            const valorPagoCol = headers.indexOf('Valor Pago'); 

            if ([nomeDividaCol, dataVencimentoCol, statusCol, valorTotalCol, valorPagoCol].some(idx => idx === -1)) {
                console.error("loadUpcomingBills: Cabeçalhos da aba 'Dividas' inválidos. Verifique a estrutura. Headers:", headers);
                $('#proximasContas').html('<div class="alert alert-danger">Erro ao carregar dívidas. Verifique a estrutura da aba "Dividas".</div>');
                return;
            }

            const today = new Date();
            today.setHours(0,0,0,0);

            const upcomingBills = [];
            data.slice(1).forEach(row => {
              const nomeDivida = row[nomeDividaCol];
              const dataVencimento = new Date(row[dataVencimentoCol]);
              dataVencimento.setHours(0,0,0,0); 
              const status = row[statusCol];
              const valorTotal = parseFloat(row[valorTotalCol] || 0);
              const valorPago = parseFloat(row[valorPagoCol] || 0);
              const valorRestante = valorTotal - valorPago;

              // Condição para incluir dívidas: Ativa ou Aguardando Início E data de vencimento está no futuro próximo (30 dias) ou já passou.
              if ((status && typeof status === 'string' && (status.trim() === 'Ativa' || status.trim() === 'Aguardando Início')) && (dataVencimento.getTime() - today.getTime()) <= (30 * 24 * 60 * 60 * 1000) && valorRestante > 0) {
                  const diffTime = dataVencimento.getTime() - today.getTime();
                  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                  upcomingBills.push({ 
                      name: nomeDivida, 
                      date: dataVencimento.toLocaleDateString('pt-BR'), 
                      daysLeft: diffDays, 
                      statusType: diffDays < 0 ? 'Atrasado' : 'Próximo',
                      valor: valorRestante
                  });
              }
            });

            if (upcomingBills.length > 0) {
                upcomingBills.sort((a,b) => {
                    // Prioriza atrasados, depois os mais próximos
                    if (a.statusType === 'Atrasado' && b.statusType !== 'Atrasado') return -1;
                    if (a.statusType !== 'Atrasado' && b.statusType === 'Atrasado') return 1;
                    return a.daysLeft - b.daysLeft; // Ordena por dias restantes
                });

                upcomingBills.forEach(bill => {
                    let statusClass = 'bg-info';
                    let statusText = `Vence em ${bill.daysLeft} dias`;
                    if (bill.daysLeft === 0) {
                        statusClass = 'bg-warning text-dark';
                        statusText = 'Vence Hoje!';
                    } else if (bill.daysLeft < 0) {
                        statusClass = 'bg-danger';
                        statusText = `Atrasado (${Math.abs(bill.daysLeft)} dias)`;
                    }

                    html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>${bill.name} - ${bill.date}</span>
                                <span class="badge bg-secondary me-2">${formatCurrency(bill.valor)}</span>
                                <span class="badge ${statusClass}">${statusText}</span>
                             </li>`;
                });
                console.log(`loadUpcomingBills: Próximas contas/dívidas populadas. Total: ${upcomingBills.length}.`);
            } else {
                html += '<li class="list-group-item text-muted">Nenhuma dívida próxima ou atrasada.</li>';
                console.log("loadUpcomingBills: Nenhuma dívida próxima ou atrasada encontrada.");
            }
          }
          html += '</ul>';
          $('#proximasContas').html(html);
        }).withFailureHandler(function(error) {
            console.error("loadUpcomingBills: Erro ao carregar próximas contas/dívidas do backend:", error.message);
            $('#proximasContas').html('<div class="alert alert-danger">Erro inesperado ao carregar dívidas: ' + error.message + '</div>');
        }).getSheetData('Dividas');
      }

      // Inicialização
      loadAccountBalances();
      loadUpcomingBills();
    });
  </script>
</body>
</html>