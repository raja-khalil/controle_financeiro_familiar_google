<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Transações - Controle Financeiro Familiar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding-top: 20px;
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    .container {
      max-width: 1000px;
      background-color: #ffffff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 50px;
    }
    h1, h2, h3 {
      color: #343a40;
    }
    .btn-back {
      margin-bottom: 20px;
    }
    .table thead th {
      background-color: #e9ecef;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
    }
    .table tbody tr:hover {
      background-color: #f2f2f2;
    }
    .alert-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
    .alert-danger { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
  </style>
</head>
<body>
  <div class="container">
    <a href="https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec" class="btn btn-secondary btn-back">← Voltar ao Menu Principal</a>
    
    <h1 class="mb-4">Transações Financeiras</h1>

    <h2 class="mt-4">Registrar Nova Transação</h2>
    <form id="transactionForm" class="row g-3 needs-validation" novalidate>
      <div class="col-md-4">
        <label for="dataTransacao" class="form-label">Data</label>
        <input type="date" class="form-control" id="dataTransacao" required>
        <div class="invalid-feedback">Por favor, insira a data.</div>
      </div>
      <div class="col-md-4">
        <label for="tipoTransacao" class="form-label">Tipo</label>
        <select class="form-select" id="tipoTransacao" required>
          <option value="">Selecione...</option>
          <option value="Entrada">Entrada</option>
          <option value="Saída">Saída</option>
        </select>
        <div class="invalid-feedback">Por favor, selecione o tipo.</div>
      </div>
      <div class="col-md-4">
        <label for="valorTransacao" class="form-label">Valor (R$)</label>
        <input type="number" step="0.01" class="form-control" id="valorTransacao" required>
        <div class="invalid-feedback">Por favor, insira o valor.</div>
      </div>
      <div class="col-md-6">
        <label for="descricaoTransacao" class="form-label">Descrição</label>
        <input type="text" class="form-control" id="descricaoTransacao" required>
        <div class="invalid-feedback">Por favor, insira a descrição.</div>
      </div>
      <div class="col-md-6">
        <label for="categoriaTransacao" class="form-label">Categoria</label>
        <select class="form-select" id="categoriaTransacao" required>
          </select>
        <div class="invalid-feedback">Por favor, selecione a categoria.</div>
      </div>
      <div class="col-md-6">
        <label for="contaTransacao" class="form-label">Conta</label>
        <select class="form-select" id="contaTransacao" required>
          </select>
        <div class="invalid-feedback">Por favor, selecione a conta.</div>
      </div>
      <div class="col-md-6">
        <label for="pessoaTransacao" class="form-label">Pessoa</label>
        <select class="form-select" id="pessoaTransacao" required>
          </select>
        <div class="invalid-feedback">Por favor, selecione a pessoa.</div>
      </div>
      <div class="col-12">
        <label for="observacoesTransacao" class="form-label">Observações</label>
        <textarea class="form-control" id="observacoesTransacao" rows="2"></textarea>
      </div>
      <div class="col-12 mt-3">
        <button class="btn btn-primary" type="submit">Salvar Transação</button>
        <div id="transactionMessage" class="mt-2"></div>
      </div>
    </form>

    <h2 class="mt-5">Histórico de Transações Recentes</h2>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Data</th>
            <th>Tipo</th>
            <th>Valor</th>
            <th>Descrição</th>
            <th>Categoria</th>
            <th>Conta</th>
            <th>Pessoa</th>
          </tr>
        </thead>
        <tbody id="transactionHistory">
          <tr><td colspan="7" class="text-center">Carregando transações...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

  <script>
    $(document).ready(function() {
      // URL da Web App já inserido aqui
      const mainAppUrl = "https://script.google.com/macros/s/AKfycbyL3wLmxmOy-JgYNY-XWkK52kwQifZQw1DEpRuQ3dfseAwaDoILjF6MG1kLvjxb3FQ-/exec"; 
      $('.btn-back').attr('href', mainAppUrl);

      // Função para carregar dados das listas suspensas (Contas, Categorias, Pessoas)
      function loadDropdowns() {
        google.script.run.withSuccessHandler(function(data) {
          const categoriasData = data.categorias;
          const contasData = data.contas;
          const pessoasData = data.pessoas;

          const categoriaHeaders = categoriasData[0];
          const categoriaNomeCol = categoriaHeaders.indexOf('Nome da Categoria');
          const categoriaTipoCol = categoriaHeaders.indexOf('Tipo');

          if (categoriaNomeCol !== -1 && categoriaTipoCol !== -1) {
            const categoriasDespesa = categoriasData.slice(1).filter(row => row[categoriaTipoCol] === 'Despesa');
            $('#categoriaTransacao').empty().append('<option value="">Selecione...</option>');
            categoriasDespesa.forEach(row => {
              $('#categoriaTransacao').append(`<option value="${row[categoriaNomeCol]}">${row[categoriaNomeCol]}</option>`);
            });
          }

          const contasHeaders = contasData[0];
          const contaNomeCol = contasHeaders.indexOf('Nome da Conta');
          const contaBancoCol = contasHeaders.indexOf('Banco');
          
          if (contaNomeCol !== -1 && contaBancoCol !== -1) {
            $('#contaTransacao').empty().append('<option value="">Selecione...</option>');
            contasData.slice(1).forEach(row => {
              const nomeConta = row[contaNomeCol];
              const banco = row[contaBancoCol];
              $('#contaTransacao').append(`<option value="${nomeConta}">${nomeConta} (${banco || 'N/A'})</option>`);
            });
          }

          const pessoasHeaders = pessoasData[0];
          const pessoaNomeCol = pessoasHeaders.indexOf('Nome');

          if (pessoaNomeCol !== -1) {
            $('#pessoaTransacao').empty().append('<option value="">Selecione...</option>');
            pessoasData.slice(1).forEach(row => {
              $('#pessoaTransacao').append(`<option value="${row[pessoaNomeCol]}">${row[pessoaNomeCol]}</option>`);
            });
          }
        }).getSheetDataBatch({
          categorias: 'Categorias',
          contas: 'Contas',
          pessoas: 'Pessoas'
        });
      }

      // Carregar Histórico de Transações Recentes
      function loadTransactionHistory() {
        google.script.run.withSuccessHandler(function(data) {
          let html = '';
          if (data.length <= 1) {
            html = '<tr><td colspan="7" class="text-center text-muted">Nenhuma transação registrada ainda.</td></tr>';
          } else {
            const headers = data[0];
            const dataCol = headers.indexOf('Data');
            const tipoCol = headers.indexOf('Tipo');
            const valorCol = headers.indexOf('Valor (R$)');
            const descricaoCol = headers.indexOf('Descricao');
            const categoriaCol = headers.indexOf('Categoria');
            const contaCol = headers.indexOf('Conta');
            const pessoaCol = headers.indexOf('Pessoa');

            if ([dataCol, tipoCol, valorCol, descricaoCol, categoriaCol, contaCol, pessoaCol].some(idx => idx === -1)) {
                console.error("Cabeçalhos da aba 'Transacoes' inválidos.");
                $('#transactionHistory').html('<tr><td colspan="7" class="text-center text-danger">Erro: Cabeçalhos da aba Transações incorretos.</td></tr>');
                return;
            }

            const recentTransactions = data.slice(1).reverse().slice(0, 50); 
            recentTransactions.forEach(row => {
              const valor = parseFloat(row[valorCol] || 0);
              const valorDisplay = row[tipoCol] === 'Saída' ? `- R$ ${valor.toFixed(2)}` : `+ R$ ${valor.toFixed(2)}`;
              const valorClass = row[tipoCol] === 'Saída' ? 'text-danger' : 'text-success';
              const rawDate = row[dataCol];
              let formattedDate = '';
              if (rawDate) {
                  const dateObj = new Date(rawDate);
                  if (!isNaN(dateObj)) { 
                      formattedDate = dateObj.toLocaleDateString('pt-BR');
                  } else {
                      formattedDate = rawDate;
                  }
              }

              html += `<tr>
                <td>${formattedDate}</td>
                <td class="${valorClass}">${row[tipoCol]}</td>
                <td class="${valorClass}">${valorDisplay}</td>
                <td>${row[descricaoCol]}</td>
                <td>${row[categoriaCol]}</td>
                <td>${row[contaCol]}</td>
                <td>${row[pessoaCol]}</td>
              </tr>`;
            });
          }
          $('#transactionHistory').html(html);
        }).getSheetData('Transacoes');
      }

      // Envio de Transação
      $('#transactionForm').on('submit', function(event) {
        event.preventDefault();
        const form = $(this)[0];
        if (!form.checkValidity()) {
          event.stopPropagation();
        } else {
          const transactionData = {
            data: $('#dataTransacao').val(),
            tipo: $('#tipoTransacao').val(),
            valor: parseFloat($('#valorTransacao').val()),
            descricao: $('#descricaoTransacao').val(),
            categoria: $('#categoriaTransacao').val(),
            conta: $('#contaTransacao').val(),
            pessoa: $('#pessoaTransacao').val(),
            observacoes: $('#observacoesTransacao').val()
          };

          google.script.run
            .withSuccessHandler(function(success) {
              if (success) {
                $('#transactionMessage').html('<div class="alert alert-success">Transação salva com sucesso!</div>');
                form.reset();
                form.classList.remove('was-validated');
                loadTransactionHistory();
              } else {
                $('#transactionMessage').html('<div class="alert alert-danger">Erro ao salvar transação. Verifique os dados e os logs do script.</div>');
              }
            })
            .withFailureHandler(function(error) {
                $('#transactionMessage').html('<div class="alert alert-danger">Ocorreu um erro inesperado: ' + error.message + '</div>');
                console.error("Erro ao salvar transação:", error);
            })
            .saveTransaction(transactionData);
        }
        form.classList.add('was-validated');
      });

      // Inicialização
      loadDropdowns();
      loadTransactionHistory();

      // Ativa a validação do Bootstrap
      const forms = document.querySelectorAll('.needs-validation');
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    });
  </script>
</body>
</html>